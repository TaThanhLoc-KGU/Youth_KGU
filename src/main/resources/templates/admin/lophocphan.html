<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω L·ªõp h·ªçc ph·∫ßn - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">
</head>
<body>
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Qu·∫£n l√Ω L·ªõp h·ªçc ph·∫ßn</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>T·∫°o l·ªõp h·ªçc ph·∫ßn
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Filter and Action Bar -->
            <div class="admin-table-wrapper">
                <div class="admin-table-header">
                    <h5 class="admin-table-title">Danh s√°ch l·ªõp h·ªçc ph·∫ßn</h5>
                    <div class="table-actions">
                        <div class="input-group me-3" style="width: 300px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="T√¨m ki·∫øm l·ªõp h·ªçc ph·∫ßn...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <button class="btn btn-success btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi
                        </button>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="subjectFilter" class="form-label">M√¥n h·ªçc:</label>
                            <select class="form-select" id="subjectFilter">
                                <option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="semesterFilter" class="form-label">H·ªçc k·ª≥:</label>
                            <select class="form-select" id="semesterFilter">
                                <option value="">T·∫•t c·∫£ h·ªçc k·ª≥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="yearFilter" class="form-label">NƒÉm h·ªçc:</label>
                            <select class="form-select" id="yearFilter">
                                <option value="">T·∫•t c·∫£ nƒÉm h·ªçc</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="teacherFilter" class="form-label">Gi·∫£ng vi√™n:</label>
                            <select class="form-select" id="teacherFilter">
                                <option value="">T·∫•t c·∫£ gi·∫£ng vi√™n</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table admin-table">
                        <thead>
                        <tr>
                            <th>M√£ LHP</th>
                            <th>M√¥n h·ªçc</th>
                            <th>Nh√≥m</th>
                            <th>H·ªçc k·ª≥</th>
                            <th>NƒÉm h·ªçc</th>
                            <th>Gi·∫£ng vi√™n</th>
                            <th>S·ªë SV</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                        </thead>
                        <tbody id="lhpTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3"></i>
                    <h4>Ch∆∞a c√≥ l·ªõp h·ªçc ph·∫ßn n√†o</h4>
                    <p class="text-muted">Nh·∫•n "T·∫°o l·ªõp h·ªçc ph·∫ßn" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal T·∫°o/S·ª≠a L·ªõp h·ªçc ph·∫ßn -->
<div class="modal fade" id="lhpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">T·∫°o l·ªõp h·ªçc ph·∫ßn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="lhpForm">
                    <input type="hidden" id="lhpId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maLhp" class="form-label">M√£ l·ªõp h·ªçc ph·∫ßn <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="maLhp" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nhom" class="form-label">Nh√≥m <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="nhom" min="1" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maMh" class="form-label">M√¥n h·ªçc <span class="text-danger">*</span></label>
                                <select class="form-select" id="maMh" required>
                                    <option value="">Ch·ªçn m√¥n h·ªçc</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maGv" class="form-label">Gi·∫£ng vi√™n <span class="text-danger">*</span></label>
                                <select class="form-select" id="maGv" required>
                                    <option value="">Ch·ªçn gi·∫£ng vi√™n</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hocKy" class="form-label">H·ªçc k·ª≥ <span class="text-danger">*</span></label>
                                <select class="form-select" id="hocKy" required>
                                    <option value="">Ch·ªçn h·ªçc k·ª≥</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="namHoc" class="form-label">NƒÉm h·ªçc <span class="text-danger">*</span></label>
                                <select class="form-select" id="namHoc" required>
                                    <option value="">Ch·ªçn nƒÉm h·ªçc</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isActive" checked>
                            <label class="form-check-label" for="isActive">K√≠ch ho·∫°t</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="saveLhp()">
                    <span class="btn-text">L∆∞u</span>
                    <div class="spinner-border spinner-border-sm d-none ms-2" role="status"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Qu·∫£n l√Ω Sinh vi√™n -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>Qu·∫£n l√Ω sinh vi√™n - <span id="currentLhpInfo"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Danh s√°ch sinh vi√™n trong l·ªõp -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-check me-2"></i>
                                    Sinh vi√™n trong l·ªõp (<span id="enrolledCount">0</span>)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="enrolledSearch"
                                           placeholder="T√¨m sinh vi√™n trong l·ªõp...">
                                </div>
                                <div class="student-list" id="enrolledStudents" style="height: 400px; overflow-y: auto;">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-success" role="status"></div>
                                        <p class="mt-2 text-muted">ƒêang t·∫£i...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Danh s√°ch sinh vi√™n c√≥ th·ªÉ th√™m -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-plus me-2"></i>
                                    Sinh vi√™n c√≥ th·ªÉ th√™m (<span id="availableCount">0</span>)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="availableSearch"
                                           placeholder="T√¨m sinh vi√™n ƒë·ªÉ th√™m...">
                                </div>
                                <div class="student-list" id="availableStudents" style="height: 400px; overflow-y: auto;">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2 text-muted">ƒêang t·∫£i...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" onclick="refreshStudentData()">
                    <i class="fas fa-sync-alt me-2"></i>L√†m m·ªõi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chuy·ªÉn nh√≥m -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Chuy·ªÉn nh√≥m h·ªçc ph·∫ßn
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Chuy·ªÉn sinh vi√™n sang nh√≥m kh√°c c·ªßa c√πng m√¥n h·ªçc
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Sinh vi√™n:</strong></label>
                    <p class="form-control-plaintext" id="transferStudentInfo"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>L·ªõp h·ªçc ph·∫ßn hi·ªán t·∫°i:</strong></label>
                    <p class="form-control-plaintext" id="transferCurrentLhp"></p>
                </div>
                <div class="mb-3">
                    <label for="transferToLhp" class="form-label">Chuy·ªÉn ƒë·∫øn l·ªõp h·ªçc ph·∫ßn: <span class="text-danger">*</span></label>
                    <select class="form-select" id="transferToLhp" required>
                        <option value="">Ch·ªçn l·ªõp h·ªçc ph·∫ßn</option>
                    </select>
                </div>
                <input type="hidden" id="transferStudentId">
                <input type="hidden" id="transferFromLhp">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-warning" onclick="executeTransfer()">
                    <i class="fas fa-exchange-alt me-2"></i>Chuy·ªÉn nh√≥m
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/sidebar.js}"></script>

<script>
    // Constants
    const API_BASE = '/api';

    // Global Data
    let lhpData = [];
    let subjectData = [];
    let teacherData = [];
    let semesterData = [];
    let yearData = [];
    let studentData = [];
    let currentLhpId = null;
    let filteredData = [];
    let enrolledStudents = [];
    let availableStudents = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
        setupEventListeners();
    });

    async function initializePage() {
        console.log('üöÄ Initializing LopHocPhan page...');
        showLoading(true);

        try {
            await Promise.all([
                loadLhpData(),
                loadSubjectData(),
                loadTeacherData(),
                loadSemesterData(),
                loadYearData(),
                loadStudentData()
            ]);

            populateFilters();
            console.log('‚úÖ Page initialized successfully');
        } catch (error) {
            console.error('‚ùå Error initializing page:', error);
            showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function setupEventListeners() {
        // Search
        document.getElementById('searchInput').addEventListener('input', filterData);

        // Filters
        document.getElementById('subjectFilter').addEventListener('change', filterData);
        document.getElementById('semesterFilter').addEventListener('change', filterData);
        document.getElementById('yearFilter').addEventListener('change', filterData);
        document.getElementById('teacherFilter').addEventListener('change', filterData);

        // Student search
        document.getElementById('enrolledSearch').addEventListener('input', filterEnrolledStudents);
        document.getElementById('availableSearch').addEventListener('input', filterAvailableStudents);

        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
    }

    // Data Loading Functions
    async function loadLhpData() {
        try {
            const response = await fetch(`${API_BASE}/lophocphan`);
            if (!response.ok) throw new Error('Failed to load LHP data');

            lhpData = await response.json();
            filteredData = [...lhpData];
            renderLhpTable();
            console.log('‚úÖ LHP data loaded:', lhpData.length);
        } catch (error) {
            console.error('‚ùå Error loading LHP:', error);
            lhpData = [];
            renderLhpTable();
        }
    }

    async function loadSubjectData() {
        try {
            const response = await fetch(`${API_BASE}/monhoc`);
            if (!response.ok) throw new Error('Failed to load subjects');

            subjectData = await response.json();
            console.log('‚úÖ Subject data loaded:', subjectData.length);
        } catch (error) {
            console.error('‚ùå Error loading subjects:', error);
            subjectData = [];
        }
    }

    async function loadTeacherData() {
        try {
            const response = await fetch(`${API_BASE}/giangvien`);
            if (!response.ok) throw new Error('Failed to load teachers');

            const allTeachers = await response.json();
            teacherData = allTeachers.filter(t => t.isActive);
            console.log('‚úÖ Teacher data loaded:', teacherData.length);
        } catch (error) {
            console.error('‚ùå Error loading teachers:', error);
            teacherData = [];
        }
    }

    async function loadSemesterData() {
        try {
            const response = await fetch(`${API_BASE}/hocky`);
            if (!response.ok) throw new Error('Failed to load semesters');

            semesterData = await response.json();
            console.log('‚úÖ Semester data loaded:', semesterData.length);
        } catch (error) {
            console.error('‚ùå Error loading semesters:', error);
            semesterData = [];
        }
    }

    async function loadYearData() {
        try {
            const response = await fetch(`${API_BASE}/namhoc`);
            if (!response.ok) throw new Error('Failed to load years');

            yearData = await response.json();
            console.log('‚úÖ Year data loaded:', yearData.length);
        } catch (error) {
            console.error('‚ùå Error loading years:', error);
            yearData = [];
        }
    }

    async function loadStudentData() {
        try {
            // S·ª≠ d·ª•ng endpoint /all ƒë·ªÉ l·∫•y t·∫•t c·∫£ sinh vi√™n
            const response = await fetch(`${API_BASE}/sinhvien/all`);
            if (!response.ok) throw new Error('Failed to load students');

            const allStudents = await response.json();

            // Filter ch·ªâ l·∫•y sinh vi√™n ƒëang ho·∫°t ƒë·ªông
            studentData = allStudents.filter(s => s.isActive);
            console.log('‚úÖ Student data loaded:', studentData.length);
        } catch (error) {
            console.error('‚ùå Error loading students:', error);
            studentData = [];
        }
    }

    // UI Functions
    function populateFilters() {
        // Subject filter
        const subjectFilter = document.getElementById('subjectFilter');
        subjectFilter.innerHTML = '<option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>';
        subjectData.forEach(subject => {
            subjectFilter.innerHTML += `<option value="${subject.maMh}">${subject.tenMh}</option>`;
        });

        // Teacher filter
        const teacherFilter = document.getElementById('teacherFilter');
        teacherFilter.innerHTML = '<option value="">T·∫•t c·∫£ gi·∫£ng vi√™n</option>';
        teacherData.forEach(teacher => {
            teacherFilter.innerHTML += `<option value="${teacher.maGv}">${teacher.hoTen}</option>`;
        });

        // Semester filter
        const semesterFilter = document.getElementById('semesterFilter');
        semesterFilter.innerHTML = '<option value="">T·∫•t c·∫£ h·ªçc k·ª≥</option>';
        semesterData.forEach(semester => {
            semesterFilter.innerHTML += `<option value="${semester.maHocKy}">${semester.tenHocKy}</option>`;
        });

        // Year filter
        const yearFilter = document.getElementById('yearFilter');
        yearFilter.innerHTML = '<option value="">T·∫•t c·∫£ nƒÉm h·ªçc</option>';
        yearData.forEach(year => {
            yearFilter.innerHTML += `<option value="${year.maNamHoc}">${year.maNamHoc}</option>`;
        });

        // Populate modal selects
        populateModalSelects();
    }

    function populateModalSelects() {
        // Modal subject select
        const maMhSelect = document.getElementById('maMh');
        maMhSelect.innerHTML = '<option value="">Ch·ªçn m√¥n h·ªçc</option>';
        subjectData.forEach(subject => {
            maMhSelect.innerHTML += `<option value="${subject.maMh}">${subject.tenMh}</option>`;
        });

        // Modal teacher select
        const maGvSelect = document.getElementById('maGv');
        maGvSelect.innerHTML = '<option value="">Ch·ªçn gi·∫£ng vi√™n</option>';
        teacherData.forEach(teacher => {
            maGvSelect.innerHTML += `<option value="${teacher.maGv}">${teacher.hoTen}</option>`;
        });

        // Modal semester select
        const hocKySelect = document.getElementById('hocKy');
        hocKySelect.innerHTML = '<option value="">Ch·ªçn h·ªçc k·ª≥</option>';
        semesterData.forEach(semester => {
            hocKySelect.innerHTML += `<option value="${semester.maHocKy}">${semester.tenHocKy}</option>`;
        });

        // Modal year select
        const namHocSelect = document.getElementById('namHoc');
        namHocSelect.innerHTML = '<option value="">Ch·ªçn nƒÉm h·ªçc</option>';
        yearData.forEach(year => {
            namHocSelect.innerHTML += `<option value="${year.maNamHoc}">${year.maNamHoc}</option>`;
        });
    }

    function renderLhpTable() {
        const tbody = document.getElementById('lhpTableBody');
        const emptyState = document.getElementById('emptyState');

        if (filteredData.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        tbody.innerHTML = filteredData.map(lhp => {
            const subject = subjectData.find(s => s.maMh === lhp.maMh) || {};
            const teacher = teacherData.find(t => t.maGv === lhp.maGv) || {};
            const semester = semesterData.find(s => s.maHocKy === lhp.hocKy) || {};

            return `
                <tr>
                    <td>
                        <strong class="text-primary">${lhp.maLhp}</strong>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-medium">${subject.tenMh || 'N/A'}</span>
                            <small class="text-muted">${lhp.maMh}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-primary">Nh√≥m ${lhp.nhom}</span>
                    </td>
                    <td>${semester.tenHocKy || lhp.hocKy}</td>
                    <td>${lhp.namHoc}</td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-medium">${teacher.hoTen || 'N/A'}</span>
                            <small class="text-muted">${lhp.maGv}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-info">${lhp.soLuongSinhVien || 0} SV</span>
                    </td>
                    <td>
                        <span class="status-badge ${lhp.isActive ? 'status-active' : 'status-inactive'}">
                            ${lhp.isActive ? 'Ho·∫°t ƒë·ªông' : 'Ng·ª´ng ho·∫°t ƒë·ªông'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="manageStudents('${lhp.maLhp}')" title="Qu·∫£n l√Ω sinh vi√™n">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn-action btn-edit" onclick="editLhp('${lhp.maLhp}')" title="S·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteLhp('${lhp.maLhp}')" title="X√≥a">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filterData() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const subjectFilter = document.getElementById('subjectFilter').value;
        const semesterFilter = document.getElementById('semesterFilter').value;
        const yearFilter = document.getElementById('yearFilter').value;
        const teacherFilter = document.getElementById('teacherFilter').value;

        filteredData = lhpData.filter(lhp => {
            const subject = subjectData.find(s => s.maMh === lhp.maMh) || {};
            const teacher = teacherData.find(t => t.maGv === lhp.maGv) || {};

            const matchesSearch = !searchTerm ||
                lhp.maLhp.toLowerCase().includes(searchTerm) ||
                (subject.tenMh && subject.tenMh.toLowerCase().includes(searchTerm)) ||
                (teacher.hoTen && teacher.hoTen.toLowerCase().includes(searchTerm)) ||
                lhp.nhom.toString().includes(searchTerm);

            const matchesSubject = !subjectFilter || lhp.maMh === subjectFilter;
            const matchesSemester = !semesterFilter || lhp.hocKy === semesterFilter;
            const matchesYear = !yearFilter || lhp.namHoc === yearFilter;
            const matchesTeacher = !teacherFilter || lhp.maGv === teacherFilter;

            return matchesSearch && matchesSubject && matchesSemester && matchesYear && matchesTeacher;
        });

        renderLhpTable();
    }

    // Modal Functions
    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'T·∫°o l·ªõp h·ªçc ph·∫ßn';
        document.getElementById('lhpForm').reset();
        document.getElementById('lhpId').value = '';
        document.getElementById('isActive').checked = true;
        currentLhpId = null;

        const modal = new bootstrap.Modal(document.getElementById('lhpModal'));
        modal.show();
    }

    function editLhp(maLhp) {
        const lhp = lhpData.find(l => l.maLhp === maLhp);
        if (!lhp) return;

        document.getElementById('modalTitle').textContent = 'S·ª≠a l·ªõp h·ªçc ph·∫ßn';
        document.getElementById('lhpId').value = lhp.maLhp;
        document.getElementById('maLhp').value = lhp.maLhp;
        document.getElementById('nhom').value = lhp.nhom;
        document.getElementById('maMh').value = lhp.maMh;
        document.getElementById('maGv').value = lhp.maGv;
        document.getElementById('hocKy').value = lhp.hocKy;
        document.getElementById('namHoc').value = lhp.namHoc;
        document.getElementById('isActive').checked = lhp.isActive;

        currentLhpId = maLhp;
        const modal = new bootstrap.Modal(document.getElementById('lhpModal'));
        modal.show();
    }

    async function saveLhp() {
        const form = document.getElementById('lhpForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const btnText = document.querySelector('.btn-text');
        const spinner = document.querySelector('.spinner-border');

        btnText.textContent = 'ƒêang l∆∞u...';
        spinner.classList.remove('d-none');

        const lhpDataToSave = {
            maLhp: document.getElementById('maLhp').value,
            nhom: parseInt(document.getElementById('nhom').value),
            maMh: document.getElementById('maMh').value,
            maGv: document.getElementById('maGv').value,
            hocKy: document.getElementById('hocKy').value,
            namHoc: document.getElementById('namHoc').value,
            isActive: document.getElementById('isActive').checked
        };

        try {
            const url = currentLhpId ? `${API_BASE}/lophocphan/${currentLhpId}` : `${API_BASE}/lophocphan`;
            const method = currentLhpId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(lhpDataToSave)
            });

            if (response.ok) {
                showNotification(currentLhpId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'T·∫°o l·ªõp h·ªçc ph·∫ßn th√†nh c√¥ng!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('lhpModal')).hide();
                await loadLhpData();
            } else {
                const error = await response.text();
                throw new Error(error);
            }
        } catch (error) {
            console.error('Error saving LHP:', error);
            showNotification('L·ªói khi l∆∞u: ' + error.message, 'error');
        } finally {
            btnText.textContent = 'L∆∞u';
            spinner.classList.add('d-none');
        }
    }

    async function deleteLhp(maLhp) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp h·ªçc ph·∫ßn n√†y?')) return;

        try {
            showLoading(true);
            const response = await fetch(`${API_BASE}/lophocphan/${maLhp}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('X√≥a l·ªõp h·ªçc ph·∫ßn th√†nh c√¥ng!', 'success');
                await loadLhpData();
            } else {
                throw new Error('Failed to delete');
            }
        } catch (error) {
            console.error('Error deleting LHP:', error);
            showNotification('L·ªói khi x√≥a l·ªõp h·ªçc ph·∫ßn', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Student Management Functions
    async function manageStudents(maLhp) {
        currentLhpId = maLhp;
        const lhp = lhpData.find(l => l.maLhp === maLhp);
        if (!lhp) return;

        const subject = subjectData.find(s => s.maMh === lhp.maMh) || {};
        document.getElementById('currentLhpInfo').textContent =
            `${lhp.maLhp} - ${subject.tenMh} (Nh√≥m ${lhp.nhom})`;

        const modal = new bootstrap.Modal(document.getElementById('studentModal'));
        modal.show();

        await loadStudentsByLhp(maLhp);
    }

    async function loadStudentsByLhp(maLhp) {
        try {
            // Load enrolled students
            const enrolledResponse = await fetch(`${API_BASE}/lophocphan/${maLhp}/sinhvien`);
            if (enrolledResponse.ok) {
                enrolledStudents = await enrolledResponse.json();
            } else {
                enrolledStudents = [];
            }

            // Load available students (not in this LHP)
            const enrolledIds = enrolledStudents.map(s => s.maSv);
            availableStudents = studentData.filter(s => !enrolledIds.includes(s.maSv));

            renderStudentLists();
        } catch (error) {
            console.error('Error loading students:', error);
            showNotification('L·ªói khi t·∫£i danh s√°ch sinh vi√™n', 'error');
        }
    }

    function renderStudentLists() {
        renderEnrolledStudents();
        renderAvailableStudents();
    }

    function renderEnrolledStudents() {
        const container = document.getElementById('enrolledStudents');
        const countElement = document.getElementById('enrolledCount');

        countElement.textContent = enrolledStudents.length;

        if (enrolledStudents.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-user-slash fa-2x text-muted mb-2"></i>
                    <p class="text-muted">Ch∆∞a c√≥ sinh vi√™n n√†o</p>
                </div>
            `;
            return;
        }

        container.innerHTML = enrolledStudents.map(student => `
            <div class="student-item border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${student.hoTen}</h6>
                        <small class="text-muted">${student.maSv}</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-warning" onclick="openTransferModal('${student.maSv}')" title="Chuy·ªÉn nh√≥m">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="removeStudent('${student.maSv}')" title="X√≥a kh·ªèi l·ªõp">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderAvailableStudents() {
        const container = document.getElementById('availableStudents');
        const countElement = document.getElementById('availableCount');

        countElement.textContent = availableStudents.length;

        if (availableStudents.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-user-check fa-2x text-muted mb-2"></i>
                    <p class="text-muted">Kh√¥ng c√≥ sinh vi√™n ƒë·ªÉ th√™m</p>
                </div>
            `;
            return;
        }

        container.innerHTML = availableStudents.map(student => `
            <div class="student-item border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${student.hoTen}</h6>
                        <small class="text-muted">${student.maSv}</small>
                    </div>
                    <button class="btn btn-outline-success btn-sm" onclick="addStudent('${student.maSv}')" title="Th√™m v√†o l·ªõp">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function addStudent(maSv) {
        if (!currentLhpId) return;

        try {
            const response = await fetch(`${API_BASE}/lophocphan/${currentLhpId}/sinhvien/${maSv}`, {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('Th√™m sinh vi√™n th√†nh c√¥ng!', 'success');
                await loadStudentsByLhp(currentLhpId);
                await loadLhpData(); // Refresh main table
            } else {
                throw new Error('Failed to add student');
            }
        } catch (error) {
            console.error('Error adding student:', error);
            showNotification('L·ªói khi th√™m sinh vi√™n', 'error');
        }
    }

    async function removeStudent(maSv) {
        if (!currentLhpId) return;
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n n√†y kh·ªèi l·ªõp?')) return;

        try {
            const response = await fetch(`${API_BASE}/lophocphan/${currentLhpId}/sinhvien/${maSv}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('X√≥a sinh vi√™n th√†nh c√¥ng!', 'success');
                await loadStudentsByLhp(currentLhpId);
                await loadLhpData(); // Refresh main table
            } else {
                throw new Error('Failed to remove student');
            }
        } catch (error) {
            console.error('Error removing student:', error);
            showNotification('L·ªói khi x√≥a sinh vi√™n', 'error');
        }
    }

    // Transfer Functions
    async function openTransferModal(maSv) {
        const student = enrolledStudents.find(s => s.maSv === maSv);
        const currentLhp = lhpData.find(l => l.maLhp === currentLhpId);

        if (!student || !currentLhp) return;

        document.getElementById('transferStudentInfo').textContent = `${student.hoTen} (${student.maSv})`;
        document.getElementById('transferCurrentLhp').textContent = `${currentLhp.maLhp} - Nh√≥m ${currentLhp.nhom}`;
        document.getElementById('transferStudentId').value = maSv;
        document.getElementById('transferFromLhp').value = currentLhpId;

        // Load available LHP for same subject
        const transferSelect = document.getElementById('transferToLhp');
        transferSelect.innerHTML = '<option value="">Ch·ªçn l·ªõp h·ªçc ph·∫ßn</option>';

        const sameLhps = lhpData.filter(l => l.maMh === currentLhp.maMh && l.maLhp !== currentLhpId && l.isActive);
        sameLhps.forEach(lhp => {
            transferSelect.innerHTML += `<option value="${lhp.maLhp}">${lhp.maLhp} - Nh√≥m ${lhp.nhom}</option>`;
        });

        const modal = new bootstrap.Modal(document.getElementById('transferModal'));
        modal.show();
    }

    async function executeTransfer() {
        const studentId = document.getElementById('transferStudentId').value;
        const fromLhp = document.getElementById('transferFromLhp').value;
        const toLhp = document.getElementById('transferToLhp').value;

        if (!toLhp) {
            showNotification('Vui l√≤ng ch·ªçn l·ªõp h·ªçc ph·∫ßn ƒë√≠ch', 'warning');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/lophocphan/transfer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    maSv: studentId,
                    fromLhp: fromLhp,
                    toLhp: toLhp
                })
            });

            if (response.ok) {
                showNotification('Chuy·ªÉn nh√≥m th√†nh c√¥ng!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
                await loadStudentsByLhp(currentLhpId);
                await loadLhpData(); // Refresh main table
            } else {
                throw new Error('Failed to transfer student');
            }
        } catch (error) {
            console.error('Error transferring student:', error);
            showNotification('L·ªói khi chuy·ªÉn nh√≥m', 'error');
        }
    }

    // Search Functions
    function filterEnrolledStudents() {
        const searchTerm = document.getElementById('enrolledSearch').value.toLowerCase();
        const filteredStudents = enrolledStudents.filter(student =>
            student.hoTen.toLowerCase().includes(searchTerm) ||
            student.maSv.toLowerCase().includes(searchTerm)
        );

        const container = document.getElementById('enrolledStudents');
        container.innerHTML = filteredStudents.map(student => `
            <div class="student-item border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${student.hoTen}</h6>
                        <small class="text-muted">${student.maSv}</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-warning" onclick="openTransferModal('${student.maSv}')" title="Chuy·ªÉn nh√≥m">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="removeStudent('${student.maSv}')" title="X√≥a kh·ªèi l·ªõp">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function filterAvailableStudents() {
        const searchTerm = document.getElementById('availableSearch').value.toLowerCase();
        const filteredStudents = availableStudents.filter(student =>
            student.hoTen.toLowerCase().includes(searchTerm) ||
            student.maSv.toLowerCase().includes(searchTerm)
        );

        const container = document.getElementById('availableStudents');
        container.innerHTML = filteredStudents.map(student => `
            <div class="student-item border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${student.hoTen}</h6>
                        <small class="text-muted">${student.maSv}</small>
                    </div>
                    <button class="btn btn-outline-success btn-sm" onclick="addStudent('${student.maSv}')" title="Th√™m v√†o l·ªõp">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Utility Functions
    async function refreshData() {
        await initializePage();
        showNotification('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi!', 'success');
    }

    async function refreshStudentData() {
        if (currentLhpId) {
            await loadStudentsByLhp(currentLhpId);
            showNotification('Danh s√°ch sinh vi√™n ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi!', 'success');
        }
    }

    function showLoading(show) {
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = show ? 'flex' : 'none';
        }
    }

    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        const alertClass = type === 'error' ? 'danger' : type;
        const iconClass = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            warning: 'exclamation-circle',
            info: 'info-circle'
        }[type] || 'info-circle';

        const alertHtml = `
            <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                <i class="fas fa-${iconClass} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', alertHtml);

        // Auto remove after 5 seconds
        setTimeout(() => {
            const alerts = container.querySelectorAll('.alert');
            if (alerts.length > 0) {
                alerts[0].remove();
            }
        }, 5000);
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');

        if (sidebar && mainContent) {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
    }
</script>
</body>
</html>
