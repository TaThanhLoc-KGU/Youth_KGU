<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫•u h√¨nh H·ªçc k·ª≥ & NƒÉm h·ªçc - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <style>
        /* Th√™m v√†o ph·∫ßn <style> */
        .semester-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .semester-timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #007bff, #28a745);
        }

        .semester-timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
        }

        .semester-timeline-item.current {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
            border-left-color: #28a745;
        }

        .semester-timeline-item.ƒëang-di·ªÖn-ra {
            border-left-color: #28a745;
        }

        .semester-timeline-item.ch∆∞a-b·∫Øt-ƒë·∫ßu {
            border-left-color: #ffc107;
        }

        .semester-timeline-item.ƒë√£-k·∫øt-th√∫c {
            border-left-color: #6c757d;
        }

        .timeline-marker {
            position: absolute;
            left: -2.25rem;
            top: 1rem;
            width: 2rem;
            height: 2rem;
            background: white;
            border: 3px solid #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .semester-timeline-item.current .timeline-marker {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }

        .order-number {
            font-size: 0.75rem;
            font-weight: bold;
        }

        .sortable-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .sortable-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: move;
            transition: all 0.2s ease;
        }

        .sortable-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sortable-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .timeline-container {
            position: relative;
            margin: 2rem 0;
        }

        .timeline {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }

        .timeline::after {
            content: '';
            position: absolute;
            width: 4px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -2px;
            border-radius: 2px;
        }

        .timeline-item {
            padding: 10px 40px;
            position: relative;
            background: inherit;
            width: 50%;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            right: -10px;
            background: white;
            border: 4px solid #667eea;
            top: 20px;
            border-radius: 50%;
            z-index: 1;
        }

        .timeline-item:nth-child(even) {
            left: 50%;
        }

        .timeline-item:nth-child(even)::after {
            left: -10px;
        }

        .timeline-item.current::after {
            background: #28a745;
            border-color: #28a745;
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3);
        }

        .timeline-content {
            padding: 1.5rem;
            background: white;
            position: relative;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .timeline-item.current .timeline-content {
            border-left-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
        }

        .progress-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .progress-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(#28a745 0deg, #28a745 var(--progress-angle), #e9ecef var(--progress-angle));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .progress-circle::before {
            content: '';
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .progress-text {
            position: relative;
            z-index: 1;
            font-weight: bold;
            color: #495057;
        }

        .semester-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .semester-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .semester-card.ongoing {
            border-left-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
        }

        .semester-card.upcoming {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
        }

        .semester-card.finished {
            border-left-color: #6c757d;
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(108, 117, 125, 0.05) 100%);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-ongoing {
            background: #d4edda;
            color: #155724;
        }

        .status-upcoming {
            background: #fff3cd;
            color: #856404;
        }

        .status-finished {
            background: #f8f9fa;
            color: #6c757d;
        }

        .quick-actions {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
            color: white;
        }

        @media screen and (max-width: 600px) {
            .timeline::after {
                left: 31px;
            }
            .timeline-item {
                width: 100%;
                padding-left: 70px;
                padding-right: 25px;
            }
            .timeline-item:nth-child(even) {
                left: 0%;
            }
            .timeline-item::after {
                left: 21px;
            }
            .timeline-item:nth-child(even)::after {
                left: 21px;
            }
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
        }

        .deleted-item {
            transition: all 0.3s ease;
        }

        .deleted-item:hover {
            background-color: #f8f9fa !important;
            border-color: #dee2e6 !important;
        }

        .dropdown-menu .dropdown-item {
            padding: 0.5rem 1rem;
        }

        .dropdown-menu .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-menu .dropdown-item.text-danger:hover {
            background-color: #f8d7da;
            color: #721c24 !important;
        }

        /* Badge styling cho tr·∫°ng th√°i */
        .badge.bg-deleted {
            background-color: #6c757d !important;
        }

        .badge.bg-active {
            background-color: #198754 !important;
        }

        .badge.bg-current {
            background-color: #fd7e14 !important;
        }

        /* Animation cho loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }


        .main-content{
            padding-left: 30px;
            padding-top: 20px;
        }


    </style>
</head>
<body>
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">C·∫•u h√¨nh H·ªçc k·ª≥ & NƒÉm h·ªçc</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openCreateAcademicYearModal()">
                        <i class="fas fa-plus me-2"></i>T·∫°o nƒÉm h·ªçc
                    </button>
                    <button class="btn btn-success" onclick="openCreateSemesterModal()">
                        <i class="fas fa-plus me-2"></i>T·∫°o h·ªçc k·ª≥
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Current Status Cards -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="progress-card">
                        <h5 class="mb-3"><i class="fas fa-calendar-alt text-primary me-2"></i>NƒÉm h·ªçc hi·ªán t·∫°i</h5>
                        <div id="currentAcademicYearInfo">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">ƒêang t·∫£i...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="progress-card">
                        <h5 class="mb-3"><i class="fas fa-clock text-success me-2"></i>H·ªçc k·ª≥ hi·ªán t·∫°i</h5>
                        <div id="currentSemesterInfo">
                            <div class="text-center py-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">ƒêang t·∫£i...</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="quick-actions">
                        <h5 class="mb-3"><i class="fas fa-bolt text-warning me-2"></i>Thao t√°c nhanh</h5>
                        <div class="d-flex flex-wrap">
                            <button class="action-button" onclick="setNextSemesterAsCurrent()">
                                <i class="fas fa-forward me-2"></i>Chuy·ªÉn h·ªçc k·ª≥ ti·∫øp theo
                            </button>
                            <button class="action-button" onclick="setNextAcademicYearAsCurrent()">
                                <i class="fas fa-fast-forward me-2"></i>Chuy·ªÉn nƒÉm h·ªçc ti·∫øp theo
                            </button>
                            <button class="action-button" onclick="generateNextAcademicYear()">
                                <i class="fas fa-magic me-2"></i>T·∫°o nƒÉm h·ªçc k·∫ø ti·∫øp
                            </button>
                            <button class="action-button" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-2"></i>L√†m m·ªõi d·ªØ li·ªáu
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab">
                        <i class="fas fa-timeline me-2"></i>Timeline
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="academic-years-tab" data-bs-toggle="tab" data-bs-target="#academic-years" type="button" role="tab">
                        <i class="fas fa-calendar me-2"></i>NƒÉm h·ªçc
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="semesters-tab" data-bs-toggle="tab" data-bs-target="#semesters" type="button" role="tab">
                        <i class="fas fa-clock me-2"></i>H·ªçc k·ª≥
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="configTabsContent">
                <!-- Timeline Tab -->
                <div class="tab-pane fade show active" id="timeline" role="tabpanel">
                    <div class="timeline-container">
                        <h5 class="text-center mb-4">Timeline NƒÉm h·ªçc & H·ªçc k·ª≥</h5>
                        <div id="timelineContainer">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">ƒêang t·∫£i timeline...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Academic Years Tab -->
                <div class="tab-pane fade" id="academic-years" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Danh s√°ch NƒÉm h·ªçc</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="filterAcademicYears('all')">T·∫•t c·∫£</button>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="filterAcademicYears('ongoing')">ƒêang di·ªÖn ra</button>
                            <button class="btn btn-outline-warning btn-sm me-2" onclick="filterAcademicYears('upcoming')">S·∫Øp t·ªõi</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="filterAcademicYears('finished')">ƒê√£ k·∫øt th√∫c</button>
                        </div>
                    </div>
                    <div id="academicYearsList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch nƒÉm h·ªçc...</p>
                        </div>
                    </div>
                </div>

                <!-- Semesters Tab -->
                <div class="tab-pane fade" id="semesters" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Danh s√°ch H·ªçc k·ª≥</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="filterSemesters('all')">T·∫•t c·∫£</button>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="filterSemesters('ongoing')">ƒêang di·ªÖn ra</button>
                            <button class="btn btn-outline-warning btn-sm me-2" onclick="filterSemesters('upcoming')">S·∫Øp t·ªõi</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="filterSemesters('finished')">ƒê√£ k·∫øt th√∫c</button>
                        </div>
                    </div>
                    <div id="semestersList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch h·ªçc k·ª≥...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal T·∫°o/S·ª≠a NƒÉm h·ªçc -->
<div class="modal fade" id="academicYearModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="academicYearModalTitle">T·∫°o nƒÉm h·ªçc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="academicYearForm">
                    <input type="hidden" id="academicYearId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maNamHoc" class="form-label">M√£ nƒÉm h·ªçc <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="maNamHoc" placeholder="2024-2025" required>
                                <small class="form-text text-muted">V√≠ d·ª•: 2024-2025</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tenNamHoc" class="form-label">T√™n nƒÉm h·ªçc <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="tenNamHoc" placeholder="NƒÉm h·ªçc 2024-2025" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayBatDauNamHoc" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayBatDauNamHoc" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayKetThucNamHoc" class="form-label">Ng√†y k·∫øt th√∫c <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayKetThucNamHoc" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="moTaNamHoc" class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="moTaNamHoc" rows="3" placeholder="M√¥ t·∫£ v·ªÅ nƒÉm h·ªçc..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActiveNamHoc" checked>
                                <label class="form-check-label" for="isActiveNamHoc">K√≠ch ho·∫°t</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isCurrentNamHoc">
                                <label class="form-check-label" for="isCurrentNamHoc">ƒê·∫∑t l√†m hi·ªán t·∫°i</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-warning" onclick="createWithSemesters()">
                    <i class="fas fa-magic me-2"></i>T·∫°o k√®m h·ªçc k·ª≥
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAcademicYear()">
                    <span class="btn-text">L∆∞u</span>
                    <div class="spinner-border spinner-border-sm d-none ms-2" role="status"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal T·∫°o/S·ª≠a H·ªçc k·ª≥ -->
<div class="modal fade" id="semesterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="semesterModalTitle">T·∫°o h·ªçc k·ª≥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="semesterForm">
                    <input type="hidden" id="semesterId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maHocKy" class="form-label">M√£ h·ªçc k·ª≥ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="maHocKy" placeholder="2024-2025_HK1" required>
                                <small class="form-text text-muted">V√≠ d·ª•: 2024-2025_HK1</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tenHocKy" class="form-label">T√™n h·ªçc k·ª≥ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="tenHocKy" placeholder="H·ªçc k·ª≥ 1 - NƒÉm h·ªçc 2024-2025" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayBatDauHocKy" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayBatDauHocKy" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayKetThucHocKy" class="form-label">Ng√†y k·∫øt th√∫c <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayKetThucHocKy" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="moTaHocKy" class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="moTaHocKy" rows="3" placeholder="M√¥ t·∫£ v·ªÅ h·ªçc k·ª≥..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActiveHocKy" checked>
                                <label class="form-check-label" for="isActiveHocKy">K√≠ch ho·∫°t</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isCurrentHocKy">
                                <label class="form-check-label" for="isCurrentHocKy">ƒê·∫∑t l√†m hi·ªán t·∫°i</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="saveSemester()">
                    <span class="btn-text">L∆∞u</span>
                    <div class="spinner-border spinner-border-sm d-none ms-2" role="status"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/sidebar.js}"></script>

<script>
    // Constants
    const API_BASE = '/api';

    // Global Data
    let academicYears = [];
    let semesters = [];
    let currentFilter = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
        setupEventListeners();
    });

    async function initializePage() {
        console.log('üöÄ Initializing Academic Configuration page...');

        try {
            await Promise.all([
                loadAcademicYears(),
                loadSemesters(),
                loadCurrentStatus()
            ]);

            renderTimeline();
            renderAcademicYearsList();
            renderSemestersList();

            console.log('‚úÖ Page initialized successfully');
        } catch (error) {
            console.error('‚ùå Error initializing page:', error);
            showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        }
    }

    // Th√™m v√†o function setupEventListeners()
    function setupEventListeners() {
        // Date validation
        document.getElementById('ngayBatDauNamHoc').addEventListener('change', validateAcademicYearDates);
        document.getElementById('ngayKetThucNamHoc').addEventListener('change', validateAcademicYearDates);
        document.getElementById('ngayBatDauHocKy').addEventListener('change', validateSemesterDates);
        document.getElementById('ngayKetThucHocKy').addEventListener('change', validateSemesterDates);

        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);

        // Auto-sync progress when semester data changes
        document.addEventListener('semesterUpdated', async (event) => {
            if (event.detail.maNamHoc) {
                await updateAcademicYearStatus(event.detail.maNamHoc);
                await loadCurrentStatus();
            }
        });
    }

    // Trigger custom event khi c√≥ thay ƒë·ªïi h·ªçc k·ª≥
    function triggerSemesterUpdated(maNamHoc) {
        const event = new CustomEvent('semesterUpdated', {
            detail: { maNamHoc: maNamHoc }
        });
        document.dispatchEvent(event);
    }

    // Data Loading Functions
    async function loadAcademicYears() {
        try {
            const response = await fetch(`${API_BASE}/namhoc/all`);
            if (!response.ok) throw new Error('Failed to load academic years');

            academicYears = await response.json();
            console.log('‚úÖ Academic years loaded:', academicYears.length);
        } catch (error) {
            console.error('‚ùå Error loading academic years:', error);
            academicYears = [];
        }
    }

    async function loadSemesters() {
        try {
            // L·∫•y t·∫•t c·∫£ h·ªçc k·ª≥ th√¥ng qua quan h·ªá v·ªõi nƒÉm h·ªçc
            const response = await fetch(`${API_BASE}/hockynamhoc`);
            if (!response.ok) throw new Error('Failed to load semester relationships');

            const semesterRelations = await response.json();

            // L·∫•y th√¥ng tin chi ti·∫øt h·ªçc k·ª≥
            const semesterPromises = semesterRelations.map(async (rel) => {
                try {
                    const hocKyResponse = await fetch(`${API_BASE}/hocky/${rel.maHocKy}`);
                    if (hocKyResponse.ok) {
                        const hocKy = await hocKyResponse.json();
                        return {
                            ...hocKy,
                            maNamHoc: rel.maNamHoc,
                            tenNamHoc: rel.tenNamHoc,
                            thuTu: rel.thuTu
                        };
                    }
                } catch (error) {
                    console.warn(`Could not load semester ${rel.maHocKy}:`, error);
                }
                return null;
            });

            const semesterResults = await Promise.all(semesterPromises);
            semesters = semesterResults.filter(s => s !== null);

            console.log('‚úÖ Semesters loaded:', semesters.length);
        } catch (error) {
            console.error('‚ùå Error loading semesters:', error);
            semesters = [];
        }
    }

    async function loadCurrentStatus() {
        try {
            // Load current academic year
            const currentYearResponse = await fetch(`${API_BASE}/namhoc/current`);
            const currentSemesterResponse = await fetch(`${API_BASE}/hocky/current`);

            if (currentYearResponse.ok) {
                const currentYear = await currentYearResponse.json();
                renderCurrentAcademicYear(currentYear);
            } else {
                renderCurrentAcademicYear(null);
            }

            if (currentSemesterResponse.ok) {
                const currentSemester = await currentSemesterResponse.json();
                renderCurrentSemester(currentSemester);
            } else {
                renderCurrentSemester(null);
            }
        } catch (error) {
            console.error('‚ùå Error loading current status:', error);
            renderCurrentAcademicYear(null);
            renderCurrentSemester(null);
        }
    }

    function renderCurrentAcademicYear(academicYear) {
        const container = document.getElementById('currentAcademicYearInfo');

        if (!academicYear) {
            container.innerHTML = `
           <div class="text-center py-4">
               <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
               <h6>Ch∆∞a c√≥ nƒÉm h·ªçc hi·ªán t·∫°i</h6>
               <p class="text-muted mb-3">Vui l√≤ng thi·∫øt l·∫≠p nƒÉm h·ªçc hi·ªán t·∫°i</p>
               <button class="btn btn-primary btn-sm" onclick="openCreateAcademicYearModal()">
                   <i class="fas fa-plus me-2"></i>T·∫°o nƒÉm h·ªçc
               </button>
           </div>
       `;
            return;
        }

        const progressAngle = academicYear.tiLePhanTram ? (academicYear.tiLePhanTram / 100) * 360 : 0;

        container.innerHTML = `
       <div class="row align-items-center">
           <div class="col-md-4 text-center">
               <div class="progress-circle" style="--progress-angle: ${progressAngle}deg;">
                   <div class="progress-text">${Math.round(academicYear.tiLePhanTram || 0)}%</div>
               </div>
           </div>
           <div class="col-md-8">
               <h6 class="text-primary">${academicYear.tenNamHoc}</h6>
               <p class="mb-2"><strong>M√£:</strong> ${academicYear.maNamHoc}</p>
               <p class="mb-2"><strong>Th·ªùi gian:</strong> ${formatDate(academicYear.ngayBatDau)} - ${formatDate(academicYear.ngayKetThuc)}</p>
               <p class="mb-2"><strong>S·ªë h·ªçc k·ª≥:</strong> ${academicYear.soHocKy || 0}</p>
               <p class="mb-2"><strong>Tr·∫°ng th√°i:</strong> <span class="status-badge status-${getStatusClass(academicYear.trangThai)}">${academicYear.trangThai}</span></p>
               ${academicYear.soNgayConLai !== null ? `<p class="mb-2"><strong>C√≤n l·∫°i:</strong> ${academicYear.soNgayConLai} ng√†y</p>` : ''}

               <!-- Th√¥ng tin h·ªçc k·ª≥ hi·ªán t·∫°i -->
               <div class="mt-3">
                   <button class="btn btn-sm btn-outline-info" onclick="showCurrentSemesterInfo('${academicYear.maNamHoc}')">
                       <i class="fas fa-list me-1"></i>Xem h·ªçc k·ª≥ (${academicYear.soHocKy || 0})
                   </button>
                   <button class="btn btn-sm btn-outline-success" onclick="syncAcademicYearProgress('${academicYear.maNamHoc}')">
                       <i class="fas fa-sync me-1"></i>ƒê·ªìng b·ªô ti·∫øn ƒë·ªô
                   </button>
               </div>
           </div>
       </div>
   `;
    }
    /**
     * Hi·ªÉn th·ªã th√¥ng tin h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc hi·ªán t·∫°i
     */
    async function showCurrentSemesterInfo(maNamHoc) {
        try {
            showLoading('ƒêang t·∫£i th√¥ng tin h·ªçc k·ª≥...');

            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/detailed-semesters`);
            if (!response.ok) throw new Error('Failed to load semester info');

            const semesterData = await response.json();

            const modalContent = `
            <div class="modal fade" id="currentSemesterInfoModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-calendar-week me-2"></i>
                                H·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc ${maNamHoc}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <h5>${semesterData.total}</h5>
                                            <small>T·ªïng h·ªçc k·ª≥</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h5>${semesterData.ongoing}</h5>
                                            <small>ƒêang di·ªÖn ra</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <h5>${Math.round(semesterData.averageProgress || 0)}%</h5>
                                            <small>Ti·∫øn ƒë·ªô TB</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="semester-timeline">
                                ${semesterData.semesters.map((sem, index) => `
                                    <div class="semester-timeline-item ${sem.isCurrent ? 'current' : ''} ${sem.trangThai.toLowerCase().replace(' ', '-')}">
                                        <div class="timeline-marker">
                                            <span class="order-number">${sem.thuTu || index + 1}</span>
                                        </div>
                                        <div class="timeline-content">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h6 class="mb-1">${sem.tenHocKy}</h6>
                                                    <small class="text-muted">${formatDate(sem.ngayBatDau)} - ${formatDate(sem.ngayKetThuc)}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-${getStatusBadgeColor(sem.trangThai)}">${sem.trangThai}</span>
                                                    ${sem.isCurrent ? '<br><span class="badge bg-warning mt-1">Hi·ªán t·∫°i</span>' : ''}
                                                </div>
                                            </div>
                                            <div class="progress mt-2" style="height: 6px;">
                                                <div class="progress-bar" style="width: ${sem.tiLePhanTram || 0}%"></div>
                                            </div>
                                            <small class="text-muted">${Math.round(sem.tiLePhanTram || 0)}% ho√†n th√†nh</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-primary" onclick="manageSemesterOrder('${maNamHoc}')">
                                <i class="fas fa-sort me-2"></i>S·∫Øp x·∫øp th·ª© t·ª±
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal
            const existingModal = document.getElementById('currentSemesterInfoModal');
            if (existingModal) existingModal.remove();

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);
            const modal = new bootstrap.Modal(document.getElementById('currentSemesterInfoModal'));
            modal.show();

            // Cleanup on close
            document.getElementById('currentSemesterInfoModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });

        } catch (error) {
            console.error('Error showing current semester info:', error);
            showNotification('L·ªói khi t·∫£i th√¥ng tin h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * ƒê·ªìng b·ªô ti·∫øn ƒë·ªô nƒÉm h·ªçc t·ª´ h·ªçc k·ª≥
     */
    async function syncAcademicYearProgress(maNamHoc) {
        try {
            showLoading('ƒêang ƒë·ªìng b·ªô ti·∫øn ƒë·ªô...');

            await updateAcademicYearStatus(maNamHoc);
            await loadCurrentStatus();

            showNotification('ƒê√£ ƒë·ªìng b·ªô ti·∫øn ƒë·ªô nƒÉm h·ªçc th√†nh c√¥ng!', 'success');

        } catch (error) {
            console.error('Error syncing progress:', error);
            showNotification('L·ªói khi ƒë·ªìng b·ªô ti·∫øn ƒë·ªô: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Qu·∫£n l√Ω th·ª© t·ª± h·ªçc k·ª≥ trong nƒÉm h·ªçc
     */
    async function manageSemesterOrder(maNamHoc) {
        try {
            showLoading('ƒêang t·∫£i danh s√°ch h·ªçc k·ª≥...');

            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/semesters-order`);
            if (!response.ok) throw new Error('Failed to load semesters');

            const semesters = await response.json();

            const modalContent = `
            <div class="modal fade" id="semesterOrderModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-sort me-2"></i>S·∫Øp x·∫øp th·ª© t·ª± h·ªçc k·ª≥
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="sortableSemesters" class="sortable-list">
                                ${semesters.map((sem, index) => `
                                    <div class="sortable-item" data-ma-hoc-ky="${sem.maHocKy}" data-thu-tu="${sem.thuTu || index + 1}">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-grip-vertical text-muted me-3"></i>
                                            <div class="flex-grow-1">
                                                <strong>${sem.tenHocKy}</strong>
                                                <br><small class="text-muted">${formatDate(sem.ngayBatDau)} - ${formatDate(sem.ngayKetThuc)}</small>
                                            </div>
                                            <span class="badge bg-primary">Th·ª© t·ª±: ${sem.thuTu || index + 1}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="button" class="btn btn-primary" onclick="saveSemesterOrder('${maNamHoc}')">
                                <i class="fas fa-save me-2"></i>L∆∞u th·ª© t·ª±
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal
            const existingModal = document.getElementById('semesterOrderModal');
            if (existingModal) existingModal.remove();

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);

            // Initialize sortable
            initializeSortable();

            const modal = new bootstrap.Modal(document.getElementById('semesterOrderModal'));
            modal.show();

        } catch (error) {
            console.error('Error managing semester order:', error);
            showNotification('L·ªói khi t·∫£i danh s√°ch h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * L∆∞u th·ª© t·ª± h·ªçc k·ª≥ m·ªõi
     */
    async function saveSemesterOrder(maNamHoc) {
        try {
            const sortableItems = document.querySelectorAll('#sortableSemesters .sortable-item');
            const orderData = Array.from(sortableItems).map((item, index) => ({
                maHocKy: item.dataset.maHocKy,
                thuTu: index + 1
            }));

            showLoading('ƒêang l∆∞u th·ª© t·ª±...');

            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/update-order`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orders: orderData })
            });

            if (response.ok) {
                showNotification('ƒê√£ c·∫≠p nh·∫≠t th·ª© t·ª± h·ªçc k·ª≥ th√†nh c√¥ng!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('semesterOrderModal')).hide();
                await initializePage();
            } else {
                throw new Error('Failed to update order');
            }

        } catch (error) {
            console.error('Error saving semester order:', error);
            showNotification('L·ªói khi l∆∞u th·ª© t·ª±: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    function renderCurrentSemester(semester) {
        const container = document.getElementById('currentSemesterInfo');

        if (!semester) {
            container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                <h6>Ch∆∞a c√≥ h·ªçc k·ª≥ hi·ªán t·∫°i</h6>
                <p class="text-muted mb-3">Vui l√≤ng thi·∫øt l·∫≠p h·ªçc k·ª≥ hi·ªán t·∫°i</p>
                <button class="btn btn-success btn-sm" onclick="openCreateSemesterModal()">
                    <i class="fas fa-plus me-2"></i>T·∫°o h·ªçc k·ª≥
                </button>
            </div>
        `;
            return;
        }

        const progressAngle = semester.tiLePhanTram ? (semester.tiLePhanTram / 100) * 360 : 0;

        container.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-4 text-center">
                <div class="progress-circle" style="--progress-angle: ${progressAngle}deg;">
                    <div class="progress-text">${Math.round(semester.tiLePhanTram || 0)}%</div>
                </div>
            </div>
            <div class="col-md-8">
                <h6 class="text-success">${semester.tenHocKy}</h6>
                <p class="mb-2"><strong>M√£:</strong> ${semester.maHocKy}</p>
                <p class="mb-2"><strong>NƒÉm h·ªçc:</strong> ${semester.tenNamHoc || 'N/A'}</p>
                ${semester.thuTu ? `<p class="mb-2"><strong>Th·ª© t·ª±:</strong> ${semester.thuTu}</p>` : ''}
                <p class="mb-2"><strong>Th·ªùi gian:</strong> ${formatDate(semester.ngayBatDau)} - ${formatDate(semester.ngayKetThuc)}</p>
                <p class="mb-2"><strong>Tr·∫°ng th√°i:</strong> <span class="status-badge status-${getStatusClass(semester.trangThai)}">${semester.trangThai}</span></p>
                ${semester.soNgayConLai !== null ? `<p class="mb-0"><strong>C√≤n l·∫°i:</strong> ${semester.soNgayConLai} ng√†y</p>` : ''}
            </div>
        </div>
    `;
    }

    function renderTimeline() {
        const container = document.getElementById('timelineContainer');

        // Combine and sort all items by date
        const allItems = [
            ...academicYears.map(item => ({...item, type: 'year'})),
            ...semesters.map(item => ({...item, type: 'semester'}))
        ].sort((a, b) => new Date(a.ngayBatDau) - new Date(b.ngayBatDau));

        if (allItems.length === 0) {
            container.innerHTML = `
               <div class="text-center py-5">
                   <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                   <h5>Ch∆∞a c√≥ d·ªØ li·ªáu</h5>
                   <p class="text-muted">Vui l√≤ng t·∫°o nƒÉm h·ªçc v√† h·ªçc k·ª≥</p>
               </div>
           `;
            return;
        }

        container.innerHTML = allItems.map((item, index) => {
            const isCurrent = item.isCurrent;
            const icon = item.type === 'year' ? 'calendar' : 'clock';
            const color = item.type === 'year' ? 'primary' : 'success';

            return `
               <div class="timeline-item ${isCurrent ? 'current' : ''}">
                   <div class="timeline-content">
                       <div class="d-flex justify-content-between align-items-start mb-2">
                           <h6 class="text-${color}">
                               <i class="fas fa-${icon} me-2"></i>
                               ${item.type === 'year' ? item.tenNamHoc : item.tenHocKy}
                               ${isCurrent ? '<span class="badge bg-success ms-2">Hi·ªán t·∫°i</span>' : ''}
                           </h6>
                           <span class="status-badge status-${getStatusClass(item.trangThai)}">${item.trangThai}</span>
                       </div>
                       <p class="mb-2">
                           <i class="fas fa-calendar-alt me-2 text-muted"></i>
                           ${formatDate(item.ngayBatDau)} - ${formatDate(item.ngayKetThuc)}
                       </p>
                       ${item.moTa ? `<p class="mb-2 text-muted">${item.moTa}</p>` : ''}
                       <div class="progress mb-2" style="height: 6px;">
                           <div class="progress-bar bg-${color}" style="width: ${item.tiLePhanTram || 0}%"></div>
                       </div>
                       <small class="text-muted">Ti·∫øn ƒë·ªô: ${Math.round(item.tiLePhanTram || 0)}%</small>

                       <div class="mt-3">
                           <button class="btn btn-outline-${color} btn-sm me-2" onclick="edit${item.type === 'year' ? 'AcademicYear' : 'Semester'}('${item.type === 'year' ? item.maNamHoc : item.maHocKy}')">
                               <i class="fas fa-edit"></i> S·ª≠a
                           </button>
                           ${!isCurrent ? `
                               <button class="btn btn-outline-warning btn-sm me-2" onclick="setAs${item.type === 'year' ? 'CurrentAcademicYear' : 'CurrentSemester'}('${item.type === 'year' ? item.maNamHoc : item.maHocKy}')">
                                   <i class="fas fa-star"></i> ƒê·∫∑t hi·ªán t·∫°i
                               </button>
                           ` : ''}
                           <button class="btn btn-outline-danger btn-sm" onclick="delete${item.type === 'year' ? 'AcademicYear' : 'Semester'}('${item.type === 'year' ? item.maNamHoc : item.maHocKy}')">
                               <i class="fas fa-trash"></i> X√≥a
                           </button>
                       </div>
                   </div>
               </div>
           `;
        }).join('');
    }

    function renderAcademicYearsList() {
        const container = document.getElementById('academicYearsList');
        let filteredYears = academicYears;

        // Apply filter
        if (currentFilter !== 'all') {
            filteredYears = academicYears.filter(year => {
                switch(currentFilter) {
                    case 'ongoing': return year.trangThai === 'ƒêang di·ªÖn ra';
                    case 'upcoming': return year.trangThai === 'Ch∆∞a b·∫Øt ƒë·∫ßu';
                    case 'finished': return year.trangThai === 'ƒê√£ k·∫øt th√∫c';
                    default: return true;
                }
            });
        }

        if (filteredYears.length === 0) {
            container.innerHTML = `
               <div class="text-center py-5">
                   <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                   <h5>Kh√¥ng c√≥ nƒÉm h·ªçc n√†o</h5>
                   <p class="text-muted">Vui l√≤ng t·∫°o nƒÉm h·ªçc m·ªõi</p>
               </div>
           `;
            return;
        }

        container.innerHTML = filteredYears.map(year => `
           <div class="semester-card ${getStatusClass(year.trangThai)}">
               <div class="row align-items-center">
                   <div class="col-md-8">
                       <div class="d-flex justify-content-between align-items-start mb-2">
                           <h6 class="text-primary">
                               ${year.tenNamHoc}
                               ${year.isCurrent ? '<span class="badge bg-success ms-2">Hi·ªán t·∫°i</span>' : ''}
                           </h6>
                           <span class="status-badge status-${getStatusClass(year.trangThai)}">${year.trangThai}</span>
                       </div>
                       <p class="mb-1"><strong>M√£:</strong> ${year.maNamHoc}</p>
                       <p class="mb-1"><strong>Th·ªùi gian:</strong> ${formatDate(year.ngayBatDau)} - ${formatDate(year.ngayKetThuc)}</p>
                       <p class="mb-1"><strong>S·ªë h·ªçc k·ª≥:</strong> ${year.soHocKy || 0}</p>
                       ${year.moTa ? `<p class="mb-2 text-muted">${year.moTa}</p>` : ''}
                   </div>
                   <div class="col-md-4 text-end">
                       <div class="progress mb-2" style="height: 8px;">
                           <div class="progress-bar" style="width: ${year.tiLePhanTram || 0}%"></div>
                       </div>
                       <small class="text-muted d-block mb-3">Ti·∫øn ƒë·ªô: ${Math.round(year.tiLePhanTram || 0)}%</small>

                       <div class="btn-group-vertical btn-group-sm">
                           <button class="btn btn-outline-primary" onclick="editAcademicYear('${year.maNamHoc}')">
                               <i class="fas fa-edit"></i> S·ª≠a
                           </button>
                           ${!year.isCurrent ? `
                               <button class="btn btn-outline-warning" onclick="setAsCurrentAcademicYear('${year.maNamHoc}')">
                                   <i class="fas fa-star"></i> ƒê·∫∑t hi·ªán t·∫°i
                               </button>
                           ` : ''}
                           <button class="btn btn-outline-danger" onclick="deleteAcademicYear('${year.maNamHoc}')">
                               <i class="fas fa-trash"></i> X√≥a
                           </button>
                       </div>
                   </div>
               </div>
           </div>
       `).join('');
    }

    function renderSemestersList() {
        const container = document.getElementById('semestersList');
        let filteredSemesters = semesters;

        // Apply filter
        if (currentFilter !== 'all') {
            filteredSemesters = semesters.filter(semester => {
                switch(currentFilter) {
                    case 'ongoing': return semester.trangThai === 'ƒêang di·ªÖn ra';
                    case 'upcoming': return semester.trangThai === 'Ch∆∞a b·∫Øt ƒë·∫ßu';
                    case 'finished': return semester.trangThai === 'ƒê√£ k·∫øt th√∫c';
                    default: return true;
                }
            });
        }

        if (filteredSemesters.length === 0) {
            container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                <h5>Kh√¥ng c√≥ h·ªçc k·ª≥ n√†o</h5>
                <p class="text-muted">Vui l√≤ng t·∫°o h·ªçc k·ª≥ m·ªõi</p>
            </div>
        `;
            return;
        }

        container.innerHTML = filteredSemesters.map(semester => `
        <div class="semester-card ${getStatusClass(semester.trangThai)}">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="text-success">
                            ${semester.tenHocKy}
                            ${semester.isCurrent ? '<span class="badge bg-success ms-2">Hi·ªán t·∫°i</span>' : ''}
                            ${semester.thuTu ? '<span class="badge bg-info ms-2">Th·ª© t·ª± ' + semester.thuTu + '</span>' : ''}
                        </h6>
                        <span class="status-badge status-${getStatusClass(semester.trangThai)}">${semester.trangThai}</span>
                    </div>
                    <p class="mb-1"><strong>M√£:</strong> ${semester.maHocKy}</p>
                    <p class="mb-1"><strong>NƒÉm h·ªçc:</strong> ${semester.tenNamHoc || 'N/A'} (${semester.maNamHoc || 'N/A'})</p>
                    <p class="mb-1"><strong>Th·ªùi gian:</strong> ${formatDate(semester.ngayBatDau)} - ${formatDate(semester.ngayKetThuc)}</p>
                    <p class="mb-1"><strong>T·ªïng s·ªë ng√†y:</strong> ${semester.tongSoNgay || 0}</p>
                    ${semester.moTa ? `<p class="mb-2 text-muted">${semester.moTa}</p>` : ''}
                </div>
                <div class="col-md-4 text-end">
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${semester.tiLePhanTram || 0}%"></div>
                    </div>
                    <small class="text-muted d-block mb-3">Ti·∫øn ƒë·ªô: ${Math.round(semester.tiLePhanTram || 0)}%</small>

                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-outline-success" onclick="editSemester('${semester.maHocKy}')">
                            <i class="fas fa-edit"></i> S·ª≠a
                        </button>
                        ${!semester.isCurrent ? `
                            <button class="btn btn-outline-warning" onclick="setAsCurrentSemester('${semester.maHocKy}')">
                                <i class="fas fa-star"></i> ƒê·∫∑t hi·ªán t·∫°i
                            </button>
                        ` : ''}
                        <!-- Dropdown menu cho x√≥a -->
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="softDeleteSemester('${semester.maHocKy}')">
                                            <i class="fas fa-trash-alt me-2 text-warning"></i>X√≥a m·ªÅm
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="removeSemesterFromYear('${semester.maNamHoc}', '${semester.maHocKy}')">
                                            <i class="fas fa-unlink me-2 text-info"></i>X√≥a kh·ªèi nƒÉm h·ªçc
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="hardDeleteSemester('${semester.maHocKy}')">
                                            <i class="fas fa-trash me-2"></i>X√≥a vƒ©nh vi·ªÖn
                                        </a>
                                    </li>
                                </ul>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    }

    // Modal Functions
    function openCreateAcademicYearModal() {
        document.getElementById('academicYearModalTitle').textContent = 'T·∫°o nƒÉm h·ªçc';
        document.getElementById('academicYearForm').reset();
        document.getElementById('academicYearId').value = '';
        document.getElementById('isActiveNamHoc').checked = true;
        document.getElementById('isCurrentNamHoc').checked = false;

        const modal = new bootstrap.Modal(document.getElementById('academicYearModal'));
        modal.show();
    }

    function openCreateSemesterModal() {
        document.getElementById('semesterModalTitle').textContent = 'T·∫°o h·ªçc k·ª≥';
        document.getElementById('semesterForm').reset();
        document.getElementById('semesterId').value = '';
        document.getElementById('isActiveHocKy').checked = true;
        document.getElementById('isCurrentHocKy').checked = false;

        // Th√™m dropdown ch·ªçn nƒÉm h·ªçc n·∫øu ch∆∞a c√≥
        addNamHocSelectToSemesterModal();

        const modal = new bootstrap.Modal(document.getElementById('semesterModal'));
        modal.show();
    }
    function addNamHocSelectToSemesterModal() {
        const existingSelect = document.getElementById('chonNamHocChoHocKy');
        if (existingSelect) return; // ƒê√£ c√≥ r·ªìi

        const form = document.getElementById('semesterForm');
        const moTaDiv = form.querySelector('#moTaHocKy').closest('.mb-3');

        // T·∫°o div ch·ªçn nƒÉm h·ªçc
        const namHocDiv = document.createElement('div');
        namHocDiv.className = 'mb-3';
        namHocDiv.innerHTML = `
        <label for="chonNamHocChoHocKy" class="form-label">NƒÉm h·ªçc <span class="text-danger">*</span></label>
        <select class="form-select" id="chonNamHocChoHocKy" required>
            <option value="">Ch·ªçn nƒÉm h·ªçc</option>
        </select>
        <small class="form-text text-muted">H·ªçc k·ª≥ s·∫Ω ƒë∆∞·ª£c t·∫°o trong nƒÉm h·ªçc n√†y</small>
    `;

        // Th√™m v√†o tr∆∞·ªõc ph·∫ßn m√¥ t·∫£
        form.insertBefore(namHocDiv, moTaDiv);

        // Populate nƒÉm h·ªçc options
        const select = document.getElementById('chonNamHocChoHocKy');
        academicYears.filter(year => year.isActive).forEach(year => {
            const option = document.createElement('option');
            option.value = year.maNamHoc;
            option.textContent = year.tenNamHoc;
            if (year.isCurrent) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }

    function addThuTuFieldToSemesterModal() {
        const existingField = document.getElementById('thuTuHocKy');
        if (existingField) return; // ƒê√£ c√≥ r·ªìi

        const form = document.getElementById('semesterForm');
        const ngayKetThucDiv = form.querySelector('#ngayKetThucHocKy').closest('.col-md-6');

        // T·∫°o field th·ª© t·ª±
        const thuTuDiv = document.createElement('div');
        thuTuDiv.className = 'col-md-6';
        thuTuDiv.innerHTML = `
        <div class="mb-3">
            <label for="thuTuHocKy" class="form-label">Th·ª© t·ª± h·ªçc k·ª≥</label>
            <select class="form-select" id="thuTuHocKy">
                <option value="">T·ª± ƒë·ªông</option>
                <option value="1">H·ªçc k·ª≥ 1</option>
                <option value="2">H·ªçc k·ª≥ 2</option>
                <option value="3">H·ªçc k·ª≥ 3</option>
                <option value="4">H·ªçc k·ª≥ h√®</option>
            </select>
            <small class="form-text text-muted">ƒê·ªÉ tr·ªëng s·∫Ω t·ª± ƒë·ªông ƒë√°nh s·ªë th·ª© t·ª±</small>
        </div>
    `;

        // Th√™m v√†o row ch·ª©a ng√†y k·∫øt th√∫c
        ngayKetThucDiv.parentNode.appendChild(thuTuDiv);
    }

    async function saveAcademicYear() {
        const form = document.getElementById('academicYearForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const btnText = document.querySelector('#academicYearModal .btn-text');
        const spinner = document.querySelector('#academicYearModal .spinner-border');

        btnText.textContent = 'ƒêang l∆∞u...';
        spinner.classList.remove('d-none');

        const yearData = {
            maNamHoc: document.getElementById('maNamHoc').value,
            tenNamHoc: document.getElementById('tenNamHoc').value,
            ngayBatDau: document.getElementById('ngayBatDauNamHoc').value,
            ngayKetThuc: document.getElementById('ngayKetThucNamHoc').value,
            moTa: document.getElementById('moTaNamHoc').value,
            isActive: document.getElementById('isActiveNamHoc').checked,
            isCurrent: document.getElementById('isCurrentNamHoc').checked
        };

        try {
            const academicYearId = document.getElementById('academicYearId').value;
            const url = academicYearId ?
                `${API_BASE}/namhoc/${academicYearId}` :
                `${API_BASE}/namhoc`;
            const method = academicYearId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(yearData)
            });

            if (response.ok) {
                showNotification(
                    academicYearId ? 'C·∫≠p nh·∫≠t nƒÉm h·ªçc th√†nh c√¥ng!' : 'T·∫°o nƒÉm h·ªçc th√†nh c√¥ng!',
                    'success'
                );
                bootstrap.Modal.getInstance(document.getElementById('academicYearModal')).hide();
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }
        } catch (error) {
            console.error('Error saving academic year:', error);
            showNotification('L·ªói khi l∆∞u: ' + error.message, 'error');
        } finally {
            btnText.textContent = 'L∆∞u';
            spinner.classList.add('d-none');
        }
    }

    async function createWithSemesters() {
        const form = document.getElementById('academicYearForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const yearData = {
            maNamHoc: document.getElementById('maNamHoc').value,
            tenNamHoc: document.getElementById('tenNamHoc').value,
            ngayBatDau: document.getElementById('ngayBatDauNamHoc').value,
            ngayKetThuc: document.getElementById('ngayKetThucNamHoc').value,
            moTa: document.getElementById('moTaNamHoc').value,
            isActive: document.getElementById('isActiveNamHoc').checked,
            isCurrent: document.getElementById('isCurrentNamHoc').checked
        };

        try {
            // T·∫°o nƒÉm h·ªçc tr∆∞·ªõc
            const response = await fetch(`${API_BASE}/namhoc`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(yearData)
            });

            if (response.ok) {
                // Sau ƒë√≥ t·∫°o h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh
                const createSemestersResponse = await fetch(`${API_BASE}/hockynamhoc/namhoc/${yearData.maNamHoc}/create-default-semesters`, {
                    method: 'POST'
                });

                if (createSemestersResponse.ok) {
                    showNotification('T·∫°o nƒÉm h·ªçc v√† h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh th√†nh c√¥ng!', 'success');
                } else {
                    showNotification('T·∫°o nƒÉm h·ªçc th√†nh c√¥ng, nh∆∞ng c√≥ l·ªói khi t·∫°o h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh', 'warning');
                }
            } else {
                const error = await response.text();
                throw new Error(error);
            }

            bootstrap.Modal.getInstance(document.getElementById('academicYearModal')).hide();
            await initializePage();
        } catch (error) {
            console.error('Error creating with semesters:', error);
            showNotification('L·ªói khi t·∫°o: ' + error.message, 'error');
        }
    }

    async function saveSemester() {
        const form = document.getElementById('semesterForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const btnText = document.querySelector('#semesterModal .btn-text');
        const spinner = document.querySelector('#semesterModal .spinner-border');

        btnText.textContent = 'ƒêang l∆∞u...';
        spinner.classList.remove('d-none');

        const semesterData = {
            maHocKy: document.getElementById('maHocKy').value,
            tenHocKy: document.getElementById('tenHocKy').value,
            ngayBatDau: document.getElementById('ngayBatDauHocKy').value,
            ngayKetThuc: document.getElementById('ngayKetThucHocKy').value,
            moTa: document.getElementById('moTaHocKy').value,
            thuTu: document.getElementById('thuTuHocKy') ? parseInt(document.getElementById('thuTuHocKy').value) : null
        };

        try {
            const semesterId = document.getElementById('semesterId').value;

            if (semesterId) {
                // C·∫≠p nh·∫≠t h·ªçc k·ª≥ hi·ªán c√≥
                const response = await fetch(`${API_BASE}/hocky/${semesterId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...semesterData,
                        isActive: document.getElementById('isActiveHocKy').checked,
                        isCurrent: document.getElementById('isCurrentHocKy').checked
                    })
                });

                if (response.ok) {
                    showNotification('C·∫≠p nh·∫≠t h·ªçc k·ª≥ th√†nh c√¥ng!', 'success');
                } else {
                    throw new Error(await response.text());
                }
            } else {
                // T·∫°o h·ªçc k·ª≥ m·ªõi - c·∫ßn ch·ªçn nƒÉm h·ªçc
                const selectedNamHoc = document.getElementById('chonNamHocChoHocKy').value;
                if (!selectedNamHoc) {
                    showNotification('Vui l√≤ng ch·ªçn nƒÉm h·ªçc cho h·ªçc k·ª≥!', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${selectedNamHoc}/hocky`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(semesterData)
                });

                if (response.ok) {
                    showNotification('T·∫°o h·ªçc k·ª≥ th√†nh c√¥ng!', 'success');
                } else {
                    throw new Error(await response.text());
                }
            }

            bootstrap.Modal.getInstance(document.getElementById('semesterModal')).hide();
            await initializePage();
        } catch (error) {
            console.error('Error saving semester:', error);
            showNotification('L·ªói khi l∆∞u: ' + error.message, 'error');
        } finally {
            btnText.textContent = 'L∆∞u';
            spinner.classList.add('d-none');
        }
    }

    // Edit Functions
    function editAcademicYear(maNamHoc) {
        const year = academicYears.find(y => y.maNamHoc === maNamHoc);
        if (!year) return;

        document.getElementById('academicYearModalTitle').textContent = 'S·ª≠a nƒÉm h·ªçc';
        document.getElementById('academicYearId').value = year.maNamHoc;
        document.getElementById('maNamHoc').value = year.maNamHoc;
        document.getElementById('tenNamHoc').value = year.tenNamHoc;
        document.getElementById('ngayBatDauNamHoc').value = year.ngayBatDau;
        document.getElementById('ngayKetThucNamHoc').value = year.ngayKetThuc;
        document.getElementById('moTaNamHoc').value = year.moTa || '';
        document.getElementById('isActiveNamHoc').checked = year.isActive;
        document.getElementById('isCurrentNamHoc').checked = year.isCurrent;

        const modal = new bootstrap.Modal(document.getElementById('academicYearModal'));
        modal.show();
    }

    function editSemester(maHocKy) {
        const semester = semesters.find(s => s.maHocKy === maHocKy);
        if (!semester) return;

        document.getElementById('semesterModalTitle').textContent = 'S·ª≠a h·ªçc k·ª≥';
        document.getElementById('semesterId').value = semester.maHocKy;
        document.getElementById('maHocKy').value = semester.maHocKy;
        document.getElementById('tenHocKy').value = semester.tenHocKy;
        document.getElementById('ngayBatDauHocKy').value = semester.ngayBatDau;
        document.getElementById('ngayKetThucHocKy').value = semester.ngayKetThuc;
        document.getElementById('moTaHocKy').value = semester.moTa || '';
        document.getElementById('isActiveHocKy').checked = semester.isActive;
        document.getElementById('isCurrentHocKy').checked = semester.isCurrent;

        // Th√™m c√°c fields n·∫øu ch∆∞a c√≥
        addNamHocSelectToSemesterModal();
        addThuTuFieldToSemesterModal();

        // Set values cho fields m·ªõi
        if (semester.maNamHoc) {
            document.getElementById('chonNamHocChoHocKy').value = semester.maNamHoc;
            document.getElementById('chonNamHocChoHocKy').disabled = true; // Kh√¥ng cho ƒë·ªïi nƒÉm h·ªçc khi edit
        }
        if (semester.thuTu) {
            document.getElementById('thuTuHocKy').value = semester.thuTu;
        }

        const modal = new bootstrap.Modal(document.getElementById('semesterModal'));
        modal.show();
    }

    // Set Current Functions
    async function setAsCurrentAcademicYear(maNamHoc) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë·∫∑t nƒÉm h·ªçc n√†y l√†m hi·ªán t·∫°i?')) return;

        try {
            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/set-current`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification('ƒê√£ ƒë·∫∑t nƒÉm h·ªçc l√†m hi·ªán t·∫°i!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to set current');
            }
        } catch (error) {
            console.error('Error setting current academic year:', error);
            showNotification('L·ªói khi ƒë·∫∑t nƒÉm h·ªçc hi·ªán t·∫°i', 'error');
        }
    }

    async function setAsCurrentSemester(maHocKy) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë·∫∑t h·ªçc k·ª≥ n√†y l√†m hi·ªán t·∫°i?')) return;

        try {
            const response = await fetch(`${API_BASE}/hocky/${maHocKy}/set-current`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification('ƒê√£ ƒë·∫∑t h·ªçc k·ª≥ l√†m hi·ªán t·∫°i!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to set current');
            }
        } catch (error) {
            console.error('Error setting current semester:', error);
            showNotification('L·ªói khi ƒë·∫∑t h·ªçc k·ª≥ hi·ªán t·∫°i', 'error');
        }
    }

    // Delete Functions
    async function deleteAcademicYear(maNamHoc) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nƒÉm h·ªçc n√†y?')) return;

        try {
            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('X√≥a nƒÉm h·ªçc th√†nh c√¥ng!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to delete');
            }
        } catch (error) {
            console.error('Error deleting academic year:', error);
            showNotification('L·ªói khi x√≥a nƒÉm h·ªçc', 'error');
        }
    }

    async function deleteSemester(maHocKy) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªçc k·ª≥ n√†y?')) return;

        try {
            const response = await fetch(`${API_BASE}/hocky/${maHocKy}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('X√≥a h·ªçc k·ª≥ th√†nh c√¥ng!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to delete');
            }
        } catch (error) {
            console.error('Error deleting semester:', error);
            showNotification('L·ªói khi x√≥a h·ªçc k·ª≥', 'error');
        }
    }

    // Quick Actions
    async function setNextSemesterAsCurrent() {
        try {
            const upcomingSemesters = semesters.filter(s => s.trangThai === 'Ch∆∞a b·∫Øt ƒë·∫ßu')
                .sort((a, b) => new Date(a.ngayBatDau) - new Date(b.ngayBatDau));

            if (upcomingSemesters.length === 0) {
                showNotification('Kh√¥ng c√≥ h·ªçc k·ª≥ s·∫Øp t·ªõi n√†o!', 'warning');
                return;
            }

            const nextSemester = upcomingSemesters[0];
            await setAsCurrentSemester(nextSemester.maHocKy);
        } catch (error) {
            console.error('Error setting next semester:', error);
            showNotification('L·ªói khi chuy·ªÉn h·ªçc k·ª≥ ti·∫øp theo', 'error');
        }
    }

    async function setNextAcademicYearAsCurrent() {
        try {
            const upcomingYears = academicYears.filter(y => y.trangThai === 'Ch∆∞a b·∫Øt ƒë·∫ßu')
                .sort((a, b) => new Date(a.ngayBatDau) - new Date(b.ngayBatDau));

            if (upcomingYears.length === 0) {
                showNotification('Kh√¥ng c√≥ nƒÉm h·ªçc s·∫Øp t·ªõi n√†o!', 'warning');
                return;
            }

            const nextYear = upcomingYears[0];
            await setAsCurrentAcademicYear(nextYear.maNamHoc);
        } catch (error) {
            console.error('Error setting next academic year:', error);
            showNotification('L·ªói khi chuy·ªÉn nƒÉm h·ªçc ti·∫øp theo', 'error');
        }
    }

    async function generateNextAcademicYear() {
        try {
            const currentYear = academicYears.find(y => y.isCurrent);
            if (!currentYear) {
                showNotification('Kh√¥ng c√≥ nƒÉm h·ªçc hi·ªán t·∫°i ƒë·ªÉ tham chi·∫øu!', 'warning');
                return;
            }

            // T·ª± ƒë·ªông t·∫°o nƒÉm h·ªçc k·∫ø ti·∫øp
            const nextStartYear = currentYear.endYear || new Date(currentYear.ngayKetThuc).getFullYear();
            const nextEndYear = nextStartYear + 1;

            const nextYearData = {
                maNamHoc: `${nextStartYear}-${nextEndYear}`,
                tenNamHoc: `NƒÉm h·ªçc ${nextStartYear}-${nextEndYear}`,
                ngayBatDau: `${nextStartYear}-09-01`, // Th∆∞·ªùng b·∫Øt ƒë·∫ßu th√°ng 9
                ngayKetThuc: `${nextEndYear}-06-30`, // K·∫øt th√∫c th√°ng 6
                moTa: `NƒÉm h·ªçc ${nextStartYear}-${nextEndYear} ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông`,
                isActive: true,
                isCurrent: false
            };

            const response = await fetch(`${API_BASE}/namhoc/with-semesters`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(nextYearData)
            });

            if (response.ok) {
                showNotification('T·∫°o nƒÉm h·ªçc k·∫ø ti·∫øp th√†nh c√¥ng!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to generate next academic year');
            }
        } catch (error) {
            console.error('Error generating next academic year:', error);
            showNotification('L·ªói khi t·∫°o nƒÉm h·ªçc k·∫ø ti·∫øp', 'error');
        }
    }

    // Filter Functions
    function filterAcademicYears(filter) {
        currentFilter = filter;
        renderAcademicYearsList();

        // Update button states
        document.querySelectorAll('#academic-years .btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        event.target.classList.remove('btn-outline-primary');
        event.target.classList.add('btn-primary');
    }

    function filterSemesters(filter) {
        currentFilter = filter;
        renderSemestersList();

        // Update button states
        document.querySelectorAll('#semesters .btn').forEach(btn => {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-success');
        });
        event.target.classList.remove('btn-outline-success');
        event.target.classList.add('btn-success');
    }

    // Validation Functions
    function validateAcademicYearDates() {
        const startDate = document.getElementById('ngayBatDauNamHoc').value;
        const endDate = document.getElementById('ngayKetThucNamHoc').value;

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());

            if (end <= start) {
                showNotification('Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu!', 'error');
                document.getElementById('ngayKetThucNamHoc').value = '';
                return false;
            }

            if (diffMonths < 6) {
                showNotification('NƒÉm h·ªçc ph·∫£i k√©o d√†i √≠t nh·∫•t 6 th√°ng!', 'warning');
                return false;
            }
        }

        return true;
    }

    function validateSemesterDates() {
        const startDate = document.getElementById('ngayBatDauHocKy').value;
        const endDate = document.getElementById('ngayKetThucHocKy').value;

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (end <= start) {
                showNotification('Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu!', 'error');
                document.getElementById('ngayKetThucHocKy').value = '';
                return false;
            }
        }

        return true;
    }

    // Utility Functions
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('vi-VN');
    }

    function getStatusClass(status) {
        switch(status) {
            case 'ƒêang di·ªÖn ra': return 'ongoing';
            case 'Ch∆∞a b·∫Øt ƒë·∫ßu': return 'upcoming';
            case 'ƒê√£ k·∫øt th√∫c': return 'finished';
            default: return 'finished';
        }
    }

    async function refreshData() {
        await initializePage();
        showNotification('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi!', 'success');
    }

    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        const alertClass = type === 'error' ? 'danger' : type;
        const iconClass = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            warning: 'exclamation-circle',
            info: 'info-circle'
        }[type] || 'info-circle';

        const alertHtml = `
           <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
               <i class="fas fa-${iconClass} me-2"></i>
               ${message}
               <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
           </div>
       `;

        container.insertAdjacentHTML('beforeend', alertHtml);

        // Auto remove after 5 seconds
        setTimeout(() => {
            const alerts = container.querySelectorAll('.alert');
            if (alerts.length > 0) {
                alerts[0].remove();
            }
        }, 5000);
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');

        if (sidebar && mainContent) {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
    }
    // ===== TH√äM V√ÄO CU·ªêI FILE cauhinh-hocky.html (TRONG TH·∫∫ <script>) =====

    /**
     * T·∫°o h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh cho nƒÉm h·ªçc s·ª≠ d·ª•ng b·∫£ng hoc_ky_nam_hoc
     */
    // Thay th·∫ø function createSemestersForYear trong cauhinh-hocky.html

    /**
     * T·∫°o h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh cho nƒÉm h·ªçc s·ª≠ d·ª•ng b·∫£ng hoc_ky_nam_hoc (3 h·ªçc k·ª≥)
     */
    async function createSemestersForYear(maNamHoc) {
        try {
            console.log('üîÑ Creating semesters for academic year:', maNamHoc);

            const confirmMessage = `T·∫°o h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh cho nƒÉm h·ªçc ${maNamHoc}?\n\n` +
                `H·ªá th·ªëng s·∫Ω t·∫°o:\n` +
                `‚Ä¢ H·ªçc k·ª≥ 1: Th√°ng 9 - Th√°ng 12 (35% th·ªùi gian)\n` +
                `‚Ä¢ H·ªçc k·ª≥ 2: Th√°ng 1 - Th√°ng 5 (40% th·ªùi gian)\n` +
                `‚Ä¢ H·ªçc k·ª≥ h√®: Th√°ng 6 - Th√°ng 8 (20% th·ªùi gian)\n\n` +
                `X√°c nh·∫≠n t·∫°o?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading('ƒêang t·∫°o 3 h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/create-semesters`, {
                method: 'POST'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const result = await response.json();

            if (result.createdSemesters && result.createdSemesters > 0) {
                showNotification(
                    `‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng ${result.createdSemesters} h·ªçc k·ª≥ cho nƒÉm h·ªçc ${maNamHoc}!`,
                    'success'
                );
                console.log('‚úÖ Created semesters:', result.semesters);
                await initializePage();
            } else {
                showNotification(result.message || 'C√≥ l·ªói khi t·∫°o h·ªçc k·ª≥', 'warning');
            }

        } catch (error) {
            console.error('‚ùå Error creating semesters:', error);
            showNotification('L·ªói khi t·∫°o h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // C·∫≠p nh·∫≠t th√¥ng b√°o trong function showSemesterListModal (n·∫øu c√≥)
    function showSemesterListModal(maNamHoc, semesters) {
        const modalTitle = `Danh s√°ch h·ªçc k·ª≥ - ${maNamHoc}`;
        const semestersList = semesters.map((semester, index) => {
            const trangThaiClass = {
                'Ch∆∞a b·∫Øt ƒë·∫ßu': 'text-info',
                'ƒêang di·ªÖn ra': 'text-success',
                'ƒê√£ k·∫øt th√∫c': 'text-secondary'
            }[semester.trangThai] || 'text-muted';

            return `
            <div class="semester-item border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${semester.tenHocKy}</h6>
                        <small class="text-muted">M√£: ${semester.maHocKy}</small>
                        <div class="mt-1">
                            <span class="badge bg-primary">Th·ª© t·ª±: ${semester.thuTu || (index + 1)}</span>
                            <span class="badge ${trangThaiClass.replace('text-', 'bg-')}">${semester.trangThai}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="d-block">${semester.ngayBatDau} ‚Üí ${semester.ngayKetThuc}</small>
                        <small class="text-muted">${semester.soNgay || 0} ng√†y</small>
                    </div>
                </div>
                ${semester.moTa ? `<p class="mt-2 mb-0 text-muted small">${semester.moTa}</p>` : ''}
            </div>
        `;
        }).join('');

        // T·∫°o v√† hi·ªÉn th·ªã modal (implementation t√πy thu·ªôc v√†o framework UI b·∫°n d√πng)
        const modalContent = `
        <div class="modal fade" id="semesterListModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${modalTitle}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge bg-info">T·ªïng: ${semesters.length} h·ªçc k·ª≥</span>
                        </div>
                        ${semestersList}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Th√™m modal v√†o DOM v√† hi·ªÉn th·ªã
        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('semesterListModal'));
        modal.show();

        // X√≥a modal khi ƒë√≥ng
        document.getElementById('semesterListModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    /**
     * Xem danh s√°ch h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc
     */
    async function viewSemestersOfYear(maNamHoc) {
        try {
            console.log('üëÅÔ∏è Viewing semesters for academic year:', maNamHoc);

            showLoading('ƒêang t·∫£i danh s√°ch h·ªçc k·ª≥...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/semesters`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const semesters = await response.json();

            if (semesters.length === 0) {
                showNotification(`NƒÉm h·ªçc ${maNamHoc} ch∆∞a c√≥ h·ªçc k·ª≥ n√†o!`, 'info');
                return;
            }

            // Hi·ªÉn th·ªã modal v·ªõi danh s√°ch h·ªçc k·ª≥
            showSemesterListModal(maNamHoc, semesters);

        } catch (error) {
            console.error('‚ùå Error viewing semesters:', error);
            showNotification('L·ªói khi xem danh s√°ch h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * X√≥a t·∫•t c·∫£ h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc
     */
    async function deleteSemestersOfYear(maNamHoc) {
        try {
            const confirmMessage = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc ${maNamHoc}?\n\n` +
                `Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ X√≥a m·ªÅm t·∫•t c·∫£ h·ªçc k·ª≥\n` +
                `‚Ä¢ X√≥a m·ªÅm relationships trong b·∫£ng hoc_ky_nam_hoc\n\n` +
                `Thao t√°c n√†y KH√îNG TH·ªÇ ho√†n t√°c!`;

            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading('ƒêang x√≥a h·ªçc k·ª≥...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/semesters`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            const result = await response.json();

            showNotification(result.message, 'success');
            await initializePage();

        } catch (error) {
            console.error('‚ùå Error deleting semesters:', error);
            showNotification('L·ªói khi x√≥a h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Hi·ªÉn th·ªã modal danh s√°ch h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc
     */
    function showSemesterListModal(maNamHoc, semesters) {
        const semesterList = semesters.map(s => `
            <div class="semester-item border rounded p-3 mb-2" style="background-color: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-primary mb-1">${s.tenHocKy}</h6>
                        <p class="mb-1 small"><strong>M√£:</strong> ${s.maHocKy}</p>
                        <p class="mb-1 small"><strong>Th·ªùi gian:</strong> ${formatDate(s.ngayBatDau)} - ${formatDate(s.ngayKetThuc)}</p>
                        ${s.moTa ? `<p class="mb-2 small text-muted">${s.moTa}</p>` : ''}
                    </div>
                    <div class="text-end">
                        <div class="mb-2">
                            <span class="badge ${s.isActive ? 'bg-success' : 'bg-secondary'} me-1">
                                ${s.isActive ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng'}
                            </span>
                            ${s.isCurrent ? '<span class="badge bg-primary">Hi·ªán t·∫°i</span>' : ''}
                        </div>
                        <div class="btn-group-vertical btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editSemester('${s.maHocKy}')">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                            ${!s.isCurrent ? `
                                <button class="btn btn-outline-warning btn-sm" onclick="setAsCurrentSemester('${s.maHocKy}')">
                                    <i class="fas fa-star"></i> ƒê·∫∑t hi·ªán t·∫°i
                                </button>
                            ` : ''}

                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        const modalHtml = `
            <div class="modal fade" id="semesterListModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-calendar-alt me-2"></i>
                                Danh s√°ch h·ªçc k·ª≥ - ${maNamHoc}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                NƒÉm h·ªçc n√†y c√≥ <strong>${semesters.length}</strong> h·ªçc k·ª≥ trong b·∫£ng <code>hoc_ky_nam_hoc</code>
                            </div>
                            ${semesterList}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" onclick="deleteSemestersOfYear('${maNamHoc}'); bootstrap.Modal.getInstance(document.getElementById('semesterListModal')).hide();">
                                <i class="fas fa-trash me-2"></i>X√≥a t·∫•t c·∫£ h·ªçc k·ª≥
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>ƒê√≥ng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // X√≥a modal c≈© n·∫øu c√≥
        const existingModal = document.getElementById('semesterListModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Th√™m modal m·ªõi
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Hi·ªÉn th·ªã modal
        const modal = new bootstrap.Modal(document.getElementById('semesterListModal'));
        modal.show();

        // Cleanup khi modal ƒë√≥ng
        document.getElementById('semesterListModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    /**
     * Enhanced renderAcademicYearsList ƒë·ªÉ th√™m buttons t·∫°o h·ªçc k·ª≥
     */
    function renderAcademicYearsList() {
        const container = document.getElementById('academicYearsList');
        let filteredYears = academicYears;

        // Apply filter
        if (currentFilter !== 'all') {
            filteredYears = academicYears.filter(year => {
                switch(currentFilter) {
                    case 'ongoing': return year.trangThai === 'ƒêang di·ªÖn ra';
                    case 'upcoming': return year.trangThai === 'Ch∆∞a b·∫Øt ƒë·∫ßu';
                    case 'finished': return year.trangThai === 'ƒê√£ k·∫øt th√∫c';
                    default: return true;
                }
            });
        }

        if (filteredYears.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5>Kh√¥ng c√≥ nƒÉm h·ªçc n√†o</h5>
                    <p class="text-muted">Vui l√≤ng t·∫°o nƒÉm h·ªçc m·ªõi</p>
                </div>
            `;
            return;
        }

        container.innerHTML = filteredYears.map(year => `
            <div class="year-card ${getStatusClass(year.trangThai)}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="text-primary">
                                ${year.tenNamHoc}
                                ${year.isCurrent ? '<span class="badge bg-primary ms-2">Hi·ªán t·∫°i</span>' : ''}
                            </h6>
                            <span class="status-badge status-${getStatusClass(year.trangThai)}">${year.trangThai}</span>
                        </div>
                        <p class="mb-1"><strong>M√£:</strong> ${year.maNamHoc}</p>
                        <p class="mb-1"><strong>Th·ªùi gian:</strong> ${formatDate(year.ngayBatDau)} - ${formatDate(year.ngayKetThuc)}</p>
                        <p class="mb-1"><strong>T·ªïng s·ªë ng√†y:</strong> ${year.tongSoNgay || 0}</p>
                        ${year.moTa ? `<p class="mb-2 text-muted">${year.moTa}</p>` : ''}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: ${year.tiLePhanTram || 0}%"></div>
                        </div>
                        <small class="text-muted d-block mb-3">Ti·∫øn ƒë·ªô: ${Math.round(year.tiLePhanTram || 0)}%</small>

                        <div class="btn-group-vertical btn-group-sm">
                            <!-- Button xem h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc -->
                            <button class="btn btn-outline-info" onclick="viewSemestersOfYear('${year.maNamHoc}')" title="Xem h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc">
                                <i class="fas fa-eye"></i> Xem h·ªçc k·ª≥
                            </button>

                            <!-- Button t·∫°o h·ªçc k·ª≥ cho nƒÉm h·ªçc -->
                            <button class="btn btn-outline-success" onclick="createSemestersForYear('${year.maNamHoc}')" title="T·∫°o h·ªçc k·ª≥ m·∫∑c ƒë·ªãnh cho nƒÉm h·ªçc">
                                <i class="fas fa-plus"></i> T·∫°o h·ªçc k·ª≥
                            </button>

                            <!-- C√°c button kh√°c -->
                            <button class="btn btn-outline-primary" onclick="editAcademicYear('${year.maNamHoc}')">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                            ${!year.isCurrent ? `
                                <button class="btn btn-outline-warning" onclick="setAsCurrentAcademicYear('${year.maNamHoc}')">
                                    <i class="fas fa-star"></i> ƒê·∫∑t hi·ªán t·∫°i
                                </button>
                            ` : ''}
                            <!-- Dropdown menu cho x√≥a -->
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="softDeleteAcademicYear('${year.maNamHoc}')">
                                            <i class="fas fa-trash-alt me-2 text-warning"></i>X√≥a m·ªÅm
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="hardDeleteAcademicYear('${year.maNamHoc}')">
                                            <i class="fas fa-trash me-2"></i>X√≥a vƒ©nh vi·ªÖn
                                        </a>
                                    </li>
                                </ul>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    /**
     * Utility functions cho loading v√† notification
     */
    function showLoading(message = 'ƒêang x·ª≠ l√Ω...') {
        let loadingEl = document.getElementById('globalLoading');
        if (!loadingEl) {
            const loadingHtml = `
                <div id="globalLoading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                     background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div class="bg-white p-4 rounded shadow">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status"></div>
                            <span id="loadingMessage">${message}</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);
        } else {
            document.getElementById('loadingMessage').textContent = message;
            loadingEl.style.display = 'flex';
        }
    }

    function hideLoading() {
        const loadingEl = document.getElementById('globalLoading');
        if (loadingEl) {
            loadingEl.remove();
        }
    }

    // =============== TH√äM V√ÄO cauhinh-hocky.html ===============

    /**
     * X√≥a m·ªÅm nƒÉm h·ªçc
     */
    async function softDeleteAcademicYear(maNamHoc) {
        try {
            const confirmMessage = `X√≥a m·ªÅm nƒÉm h·ªçc ${maNamHoc}?\n\n` +
                `Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ ƒê·∫∑t nƒÉm h·ªçc th√†nh tr·∫°ng th√°i kh√¥ng ho·∫°t ƒë·ªông\n` +
                `‚Ä¢ X√≥a m·ªÅm t·∫•t c·∫£ h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc\n` +
                `‚Ä¢ C√≥ th·ªÉ kh√¥i ph·ª•c sau n√†y\n\n` +
                `X√°c nh·∫≠n x√≥a m·ªÅm?`;

            if (!confirm(confirmMessage)) return;

            showLoading('ƒêang x√≥a m·ªÅm nƒÉm h·ªçc...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`‚úÖ ƒê√£ x√≥a m·ªÅm nƒÉm h·ªçc ${maNamHoc}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('‚ùå Error soft deleting academic year:', error);
            showNotification('L·ªói khi x√≥a m·ªÅm nƒÉm h·ªçc: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * X√≥a vƒ©nh vi·ªÖn nƒÉm h·ªçc
     */
    async function hardDeleteAcademicYear(maNamHoc) {
        try {
            const confirmMessage = `‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN nƒÉm h·ªçc ${maNamHoc}?\n\n` +
                `C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ X√≥a vƒ©nh vi·ªÖn nƒÉm h·ªçc kh·ªèi c∆° s·ªü d·ªØ li·ªáu\n` +
                `‚Ä¢ X√≥a vƒ©nh vi·ªÖn T·∫§T C·∫¢ h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc\n` +
                `‚Ä¢ KH√îNG TH·ªÇ kh√¥i ph·ª•c sau n√†y\n\n` +
                `G√µ "${maNamHoc}" ƒë·ªÉ x√°c nh·∫≠n x√≥a vƒ©nh vi·ªÖn:`;

            const userInput = prompt(confirmMessage);
            if (userInput !== maNamHoc) {
                showNotification('X√°c nh·∫≠n kh√¥ng ch√≠nh x√°c. H·ªßy thao t√°c.', 'warning');
                return;
            }

            showLoading('ƒêang x√≥a vƒ©nh vi·ªÖn nƒÉm h·ªçc...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/permanent`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`‚úÖ ƒê√£ x√≥a vƒ©nh vi·ªÖn nƒÉm h·ªçc ${maNamHoc}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('‚ùå Error hard deleting academic year:', error);
            showNotification('L·ªói khi x√≥a vƒ©nh vi·ªÖn nƒÉm h·ªçc: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Kh√¥i ph·ª•c nƒÉm h·ªçc ƒë√£ x√≥a m·ªÅm
     */
    async function restoreAcademicYear(maNamHoc) {
        try {
            const confirmMessage = `Kh√¥i ph·ª•c nƒÉm h·ªçc ${maNamHoc}?\n\n` +
                `Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ K√≠ch ho·∫°t l·∫°i nƒÉm h·ªçc\n` +
                `‚Ä¢ Kh√¥i ph·ª•c t·∫•t c·∫£ h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc\n\n` +
                `X√°c nh·∫≠n kh√¥i ph·ª•c?`;

            if (!confirm(confirmMessage)) return;

            showLoading('ƒêang kh√¥i ph·ª•c nƒÉm h·ªçc...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/restore`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification(`‚úÖ ƒê√£ kh√¥i ph·ª•c nƒÉm h·ªçc ${maNamHoc}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('‚ùå Error restoring academic year:', error);
            showNotification('L·ªói khi kh√¥i ph·ª•c nƒÉm h·ªçc: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * X√≥a m·ªÅm h·ªçc k·ª≥
     */
    async function softDeleteSemester(maHocKy) {
        try {
            const confirmMessage = `X√≥a m·ªÅm h·ªçc k·ª≥ ${maHocKy}?\n\n` +
                `Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ ƒê·∫∑t h·ªçc k·ª≥ th√†nh tr·∫°ng th√°i kh√¥ng ho·∫°t ƒë·ªông\n` +
                `‚Ä¢ X√≥a m·ªÅm kh·ªèi t·∫•t c·∫£ nƒÉm h·ªçc\n` +
                `‚Ä¢ C√≥ th·ªÉ kh√¥i ph·ª•c sau n√†y\n\n` +
                `X√°c nh·∫≠n x√≥a m·ªÅm?`;

            if (!confirm(confirmMessage)) return;

            showLoading('ƒêang x√≥a m·ªÅm h·ªçc k·ª≥...');

            const response = await fetch(`${API_BASE}/hocky/${maHocKy}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`‚úÖ ƒê√£ x√≥a m·ªÅm h·ªçc k·ª≥ ${maHocKy}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('‚ùå Error soft deleting semester:', error);
            showNotification('L·ªói khi x√≥a m·ªÅm h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * X√≥a h·ªçc k·ª≥ kh·ªèi nƒÉm h·ªçc c·ª• th·ªÉ
     */
    async function removeSemesterFromYear(maNamHoc, maHocKy) {
        try {
            const confirmMessage = `X√≥a h·ªçc k·ª≥ ${maHocKy} kh·ªèi nƒÉm h·ªçc ${maNamHoc}?\n\n` +
                `Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ X√≥a m·ªëi li√™n k·∫øt gi·ªØa h·ªçc k·ª≥ v√† nƒÉm h·ªçc\n` +
                `‚Ä¢ C·∫≠p nh·∫≠t l·∫°i th·ª© t·ª± c√°c h·ªçc k·ª≥ c√≤n l·∫°i\n` +
                `‚Ä¢ H·ªçc k·ª≥ v·∫´n t·ªìn t·∫°i v√† c√≥ th·ªÉ g√°n cho nƒÉm h·ªçc kh√°c\n\n` +
                `X√°c nh·∫≠n x√≥a?`;

            if (!confirm(confirmMessage)) return;

            showLoading('ƒêang x√≥a h·ªçc k·ª≥ kh·ªèi nƒÉm h·ªçc...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/semesters/${maHocKy}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`‚úÖ ${result.message}`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('‚ùå Error removing semester from year:', error);
            showNotification('L·ªói khi x√≥a h·ªçc k·ª≥ kh·ªèi nƒÉm h·ªçc: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Kh√¥i ph·ª•c h·ªçc k·ª≥ ƒë√£ x√≥a m·ªÅm
     */
    async function restoreSemester(maHocKy) {
        try {
            const confirmMessage = `Kh√¥i ph·ª•c h·ªçc k·ª≥ ${maHocKy}?\n\n` +
                `Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ K√≠ch ho·∫°t l·∫°i h·ªçc k·ª≥\n` +
                `‚Ä¢ Kh√¥i ph·ª•c t·∫•t c·∫£ m·ªëi li√™n k·∫øt v·ªõi nƒÉm h·ªçc\n\n` +
                `X√°c nh·∫≠n kh√¥i ph·ª•c?`;

            if (!confirm(confirmMessage)) return;

            showLoading('ƒêang kh√¥i ph·ª•c h·ªçc k·ª≥...');

            const response = await fetch(`${API_BASE}/hocky/${maHocKy}/restore`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification(`‚úÖ ƒê√£ kh√¥i ph·ª•c h·ªçc k·ª≥ ${maHocKy}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('‚ùå Error restoring semester:', error);
            showNotification('L·ªói khi kh√¥i ph·ª•c h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xem danh s√°ch c√°c item ƒë√£ x√≥a m·ªÅm
     */
    async function viewDeletedItems() {
        try {
            showLoading('ƒêang t·∫£i danh s√°ch ƒë√£ x√≥a...');

            // L·∫•y nƒÉm h·ªçc ƒë√£ x√≥a
            const deletedYearsResponse = await fetch(`${API_BASE}/namhoc/deleted`);
            const deletedYears = deletedYearsResponse.ok ? await deletedYearsResponse.json() : [];

            // L·∫•y h·ªçc k·ª≥ ƒë√£ x√≥a
            const deletedSemestersResponse = await fetch(`${API_BASE}/hocky/deleted`);
            const deletedSemesters = deletedSemestersResponse.ok ? await deletedSemestersResponse.json() : [];

            showDeletedItemsModal(deletedYears, deletedSemesters);

        } catch (error) {
            console.error('‚ùå Error loading deleted items:', error);
            showNotification('L·ªói khi t·∫£i danh s√°ch ƒë√£ x√≥a: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Hi·ªÉn th·ªã modal danh s√°ch ƒë√£ x√≥a m·ªÅm
     */
    function showDeletedItemsModal(deletedYears, deletedSemesters) {
        const yearsList = deletedYears.map(year => `
        <div class="deleted-item border rounded p-3 mb-2 bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 text-muted">${year.tenNamHoc}</h6>
                    <small class="text-muted">M√£: ${year.maNamHoc}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="restoreAcademicYear('${year.maNamHoc}')">
                        <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="hardDeleteAcademicYear('${year.maNamHoc}')">
                        <i class="fas fa-trash"></i> X√≥a vƒ©nh vi·ªÖn
                    </button>
                </div>
            </div>
        </div>
    `).join('');

        const semestersList = deletedSemesters.map(semester => `
        <div class="deleted-item border rounded p-3 mb-2 bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 text-muted">${semester.tenHocKy}</h6>
                    <small class="text-muted">M√£: ${semester.maHocKy}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="restoreSemester('${semester.maHocKy}')">
                        <i class="fas fa-undo"></i> Kh√¥i ph·ª•c
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="hardDeleteSemester('${semester.maHocKy}')">
                        <i class="fas fa-trash"></i> X√≥a vƒ©nh vi·ªÖn
                    </button>
                </div>
            </div>
        </div>
    `).join('');

        const modalContent = `
        <div class="modal fade" id="deletedItemsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-trash-restore me-2"></i>Danh S√°ch ƒê√£ X√≥a M·ªÅm
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-calendar-alt me-2"></i>NƒÉm H·ªçc ƒê√£ X√≥a
                                    <span class="badge bg-secondary">${deletedYears.length}</span>
                                </h6>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${yearsList || '<p class="text-muted">Kh√¥ng c√≥ nƒÉm h·ªçc n√†o ƒë√£ x√≥a m·ªÅm</p>'}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-calendar-week me-2"></i>H·ªçc K·ª≥ ƒê√£ X√≥a
                                    <span class="badge bg-secondary">${deletedSemesters.length}</span>
                                </h6>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${semestersList || '<p class="text-muted">Kh√¥ng c√≥ h·ªçc k·ª≥ n√†o ƒë√£ x√≥a m·ªÅm</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // X√≥a modal c≈© n·∫øu c√≥
        const existingModal = document.getElementById('deletedItemsModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Th√™m modal m·ªõi
        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('deletedItemsModal'));
        modal.show();

        // X√≥a modal khi ƒë√≥ng
        document.getElementById('deletedItemsModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    /**
     * X√≥a vƒ©nh vi·ªÖn h·ªçc k·ª≥
     */
    async function hardDeleteSemester(maHocKy) {
        try {
            const confirmMessage = `‚ö†Ô∏è X√ìA Vƒ®NH VI·ªÑN h·ªçc k·ª≥ ${maHocKy}?\n\n` +
                `C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω:\n` +
                `‚Ä¢ X√≥a vƒ©nh vi·ªÖn h·ªçc k·ª≥ kh·ªèi c∆° s·ªü d·ªØ li·ªáu\n` +
                `‚Ä¢ X√≥a t·∫•t c·∫£ m·ªëi li√™n k·∫øt v·ªõi nƒÉm h·ªçc\n` +
                `‚Ä¢ KH√îNG TH·ªÇ kh√¥i ph·ª•c sau n√†y\n\n` +
                `G√µ "${maHocKy}" ƒë·ªÉ x√°c nh·∫≠n x√≥a vƒ©nh vi·ªÖn:`;

            const userInput = prompt(confirmMessage);
            if (userInput !== maHocKy) {
                showNotification('X√°c nh·∫≠n kh√¥ng ch√≠nh x√°c. H·ªßy thao t√°c.', 'warning');
                return;
            }

            showLoading('ƒêang x√≥a vƒ©nh vi·ªÖn h·ªçc k·ª≥...');

            const response = await fetch(`${API_BASE}/hocky/${maHocKy}/permanent`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`‚úÖ ƒê√£ x√≥a vƒ©nh vi·ªÖn h·ªçc k·ª≥ ${maHocKy}!`, 'success');

                // ƒê√≥ng modal v√† refresh
                const modal = bootstrap.Modal.getInstance(document.getElementById('deletedItemsModal'));
                if (modal) modal.hide();

                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('‚ùå Error hard deleting semester:', error);
            showNotification('L·ªói khi x√≥a vƒ©nh vi·ªÖn h·ªçc k·ª≥: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * C·∫≠p nh·∫≠t menu actions ƒë·ªÉ bao g·ªìm c√°c ch·ª©c nƒÉng x√≥a m·ªÅm
     */
    function updateActionMenus() {
        // Th√™m n√∫t "Xem ƒë√£ x√≥a" v√†o header
        const headerActions = document.querySelector('.header-actions');
        if (headerActions) {
            const deletedButton = `
            <button class="btn btn-outline-secondary" onclick="viewDeletedItems()">
                <i class="fas fa-trash-restore me-2"></i>Xem ƒê√£ X√≥a
            </button>
        `;
            headerActions.insertAdjacentHTML('beforeend', deletedButton);
        }
    }

    // G·ªçi function ƒë·ªÉ c·∫≠p nh·∫≠t menu khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        updateActionMenus();
    });

    function showLoading(message = 'ƒêang x·ª≠ l√Ω...') {
        const overlay = `
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p class="mb-0">${message}</p>
            </div>
        </div>
    `;
        document.body.insertAdjacentHTML('beforeend', overlay);
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
    /**
     * T√≠nh to√°n ti·∫øn ƒë·ªô nƒÉm h·ªçc d·ª±a tr√™n c√°c h·ªçc k·ª≥ b√™n trong
     */
    async function calculateAcademicYearProgress(maNamHoc) {
        try {
            // L·∫•y danh s√°ch h·ªçc k·ª≥ c·ªßa nƒÉm h·ªçc
            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/semesters-with-progress`);
            if (!response.ok) return 0;

            const semesters = await response.json();
            if (semesters.length === 0) return 0;

            // T√≠nh tr·ªçng s·ªë d·ª±a tr√™n s·ªë ng√†y c·ªßa m·ªói h·ªçc k·ª≥
            let totalWeightedProgress = 0;
            let totalWeight = 0;

            semesters.forEach(semester => {
                const weight = semester.tongSoNgay || 1;
                const progress = semester.tiLePhanTram || 0;

                totalWeightedProgress += (progress * weight);
                totalWeight += weight;
            });

            return totalWeight > 0 ? totalWeightedProgress / totalWeight : 0;
        } catch (error) {
            console.error('Error calculating academic year progress:', error);
            return 0;
        }
    }

    /**
     * C·∫≠p nh·∫≠t tr·∫°ng th√°i nƒÉm h·ªçc d·ª±a tr√™n h·ªçc k·ª≥
     */
    async function updateAcademicYearStatus(maNamHoc) {
        try {
            const semestersResponse = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/semesters`);
            if (!semestersResponse.ok) return;

            const semesters = await semestersResponse.json();
            if (semesters.length === 0) return;

            const currentDate = new Date();
            const ongoingSemesters = semesters.filter(s => s.trangThai === 'ƒêang di·ªÖn ra');

            let newStatus = 'Ch∆∞a b·∫Øt ƒë·∫ßu';
            if (ongoingSemesters.length > 0) {
                newStatus = 'ƒêang di·ªÖn ra';
            } else {
                const finishedSemesters = semesters.filter(s => s.trangThai === 'ƒê√£ k·∫øt th√∫c');
                if (finishedSemesters.length === semesters.length) {
                    newStatus = 'ƒê√£ k·∫øt th√∫c';
                }
            }

            // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
            const progress = await calculateAcademicYearProgress(maNamHoc);

            // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t
            await fetch(`${API_BASE}/namhoc/${maNamHoc}/update-progress`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    trangThai: newStatus,
                    tiLePhanTram: progress
                })
            });

        } catch (error) {
            console.error('Error updating academic year status:', error);
        }
    }
    /**
     * Initialize sortable functionality
     */
    function initializeSortable() {
        const sortableContainer = document.getElementById('sortableSemesters');
        if (!sortableContainer) return;

        let draggedElement = null;

        // Add drag event listeners to items
        const items = sortableContainer.querySelectorAll('.sortable-item');
        items.forEach(item => {
            item.draggable = true;

            item.addEventListener('dragstart', (e) => {
                draggedElement = item;
                item.classList.add('dragging');
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                draggedElement = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedElement && draggedElement !== item) {
                    const bounding = item.getBoundingClientRect();
                    const offset = bounding.y + (bounding.height / 2);

                    if (e.clientY - offset > 0) {
                        item.parentNode.insertBefore(draggedElement, item.nextSibling);
                    } else {
                        item.parentNode.insertBefore(draggedElement, item);
                    }

                    // Update order numbers
                    updateOrderNumbers();
                }
            });
        });
    }

    function updateOrderNumbers() {
        const items = document.querySelectorAll('#sortableSemesters .sortable-item');
        items.forEach((item, index) => {
            const badge = item.querySelector('.badge');
            if (badge) {
                badge.textContent = `Th·ª© t·ª±: ${index + 1}`;
            }
        });
    }

    function getStatusBadgeColor(status) {
        switch(status) {
            case 'ƒêang di·ªÖn ra': return 'success';
            case 'Ch∆∞a b·∫Øt ƒë·∫ßu': return 'warning';
            case 'ƒê√£ k·∫øt th√∫c': return 'secondary';
            default: return 'secondary';
        }
    }
</script>
</body>
</html>