<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Sinh vi√™n - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS - T√°i s·ª≠ d·ª•ng CSS hi·ªán c√≥ -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/student.css}" rel="stylesheet">

    <style>
        /* Modal Attendance Styles */
        .subject-item {
            transition: all 0.3s ease;
        }

        .subject-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .progress {
            border-radius: 10px;
        }

        .progress-bar {
            border-radius: 10px;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .table th {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .badge {
            font-weight: 500;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
        }

        /* Chart container */
        #attendanceChart {
            max-height: 300px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-xl {
                max-width: 95%;
                margin: 1rem auto;
            }

            .subject-item .row {
                font-size: 0.875rem;
            }
        }
        /* Biometric Status Styles */
        .biometric-overview {
            text-align: center;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 1.5rem;
        }

        .biometric-overview.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .biometric-overview.ready {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
        }

        .biometric-overview.partial {
            background: linear-gradient(135deg, #f8d7da, #f5c2c7);
            color: #721c24;
        }

        .biometric-overview.empty {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #6c757d;
        }

        .status-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .biometric-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .detail-item i {
            font-size: 1.5rem;
        }

        .detail-content {
            flex: 1;
        }

        .detail-status {
            font-weight: 600;
            color: var(--primary-color);
        }

        .setup-action {
            margin-top: 1.5rem;
        }

        .dashboard-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 1.5rem;
            border-bottom: none;
        }

        .card-title {
            margin: 0;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .card-body {
            padding: 2rem;
        }
    </style>
</head>

<body class="student-dashboard">
<div class="main-wrapper">
    <!-- Include Sidebar Component - T√°i s·ª≠ d·ª•ng sidebar hi·ªán c√≥ -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left ">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">
                        <i class="fas fa-graduation-cap me-2"></i>
                        Dashboard Sinh vi√™n
                    </h1>
                </div>
                <div class="header-right">
                    <div class="welcome-info">
                        <span class="welcome-text">Xin ch√†o, </span>
                        <span class="user-name" th:text="${student?.hoTen ?: 'Sinh vi√™n'}">Sinh vi√™n</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="container-fluid">

                <!-- Error Alert -->
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span th:text="${error}">L·ªói x·∫£y ra</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Welcome Section -->
                <div class="welcome-header mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="welcome-title">
                                <i class="fas fa-user-circle me-2"></i>
                                <span th:text="${student?.hoTen ?: 'Sinh vi√™n'}">Sinh vi√™n</span>
                            </h2>
                            <p class="welcome-subtitle">
                                M√£ sinh vi√™n: <strong th:text="${student?.maSv ?: 'N/A'}">20210001</strong>
                                | L·ªõp: <strong th:text="${student?.maLop ?: 'Ch∆∞a ph√¢n l·ªõp'}">CNTT01</strong>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="current-date">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <span id="currentDate"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- M·ª§C TI√äU 1: Ki·ªÉm tra t√¨nh tr·∫°ng sinh tr·∫Øc h·ªçc -->
                <div class="row">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="fas fa-user-shield me-2"></i>
                                    T√¨nh tr·∫°ng Sinh tr·∫Øc h·ªçc
                                </h5>
                            </div>
                            <div class="card-body">

                                <!-- Biometric Status Overview -->
                                <div class="biometric-overview" th:classappend="${biometricStatus ?: 'empty'}">
                                    <div class="status-icon">
                                        <div th:switch="${biometricStatus}">
                                            <i th:case="'completed'" class="fas fa-check-circle text-success"></i>
                                            <i th:case="'ready'" class="fas fa-exclamation-triangle text-warning"></i>
                                            <i th:case="'partial'" class="fas fa-clock text-info"></i>
                                            <i th:case="*" class="fas fa-times-circle text-muted"></i>
                                        </div>
                                    </div>

                                    <div class="status-content">
                                        <div th:switch="${biometricStatus}">
                                        <div th:case="'completed'">
                                            <h4>
                                                <span class="badge bg-success me-2">
                                                    <i class="fas fa-check-circle"></i>
                                                </span>
                                                ƒê√£ s·∫µn s√†ng ƒëi·ªÉm danh
                                            </h4>
                                            <p>Sinh tr·∫Øc h·ªçc ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p ho√†n t·∫•t. B·∫°n c√≥ th·ªÉ tham gia ƒëi·ªÉm danh b·∫±ng khu√¥n m·∫∑t.</p>
                                        </div>
                                            <div th:case="'ready'">
                                                <h4>
                                                    <span class="badge bg-warning text-dark me-2">
                                                        <i class="fas fa-exclamation-triangle"></i>
                                                    </span>
                                                    C·∫ßn tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng
                                                </h4>
                                                <p>ƒê√£ c√≥ ƒë·ªß ·∫£nh khu√¥n m·∫∑t nh∆∞ng ch∆∞a tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng AI. H√£y li√™n h·ªá admin ƒë·ªÉ ho√†n t·∫•t.</p>
                                            </div>
                                            <div th:case="'partial'">
                                                <h4>üîÑ C·∫ßn upload th√™m ·∫£nh</h4>
                                                <p>C·∫ßn upload th√™m ·∫£nh khu√¥n m·∫∑t ƒë·ªÉ ho√†n t·∫•t thi·∫øt l·∫≠p sinh tr·∫Øc h·ªçc.</p>
                                            </div>
                                            <div th:case="*">
                                                <h4>‚ùå Ch∆∞a thi·∫øt l·∫≠p sinh tr·∫Øc h·ªçc</h4>
                                                <p>B·∫°n ch∆∞a thi·∫øt l·∫≠p sinh tr·∫Øc h·ªçc. H√£y upload ·∫£nh khu√¥n m·∫∑t ƒë·ªÉ c√≥ th·ªÉ ƒëi·ªÉm danh.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- M·ª§C TI√äU 2: Chi ti·∫øt ki·ªÉm tra t·ª´ng th√†nh ph·∫ßn -->
                                <div class="biometric-details">
                                    <!-- Ki·ªÉm tra s·ªë l∆∞·ª£ng ·∫£nh khu√¥n m·∫∑t -->
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-images"
                                               th:classappend="${faceImageCount >= 3} ? 'text-success' : 'text-muted'"></i>
                                        </div>
                                        <div class="detail-content">
                                            <div class="detail-label">·∫¢nh khu√¥n m·∫∑t</div>
                                            <div class="detail-status"
                                                 th:text="${faceImageCount ?: 0} + '/3 ·∫£nh'">0/3 ·∫£nh</div>
                                            <small class="text-muted">C·∫ßn t·ªëi thi·ªÉu 3 ·∫£nh</small>
                                        </div>
                                    </div>

                                    <!-- Ki·ªÉm tra ·∫£nh ƒë·∫°i di·ªán -->
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-user-circle"
                                               th:classappend="${hasProfileImage} ? 'text-success' : 'text-muted'"></i>
                                        </div>
                                        <div class="detail-content">
                                            <div class="detail-label">·∫¢nh ƒë·∫°i di·ªán</div>
                                            <div class="detail-status"
                                                 th:text="${hasProfileImage} ? 'ƒê√£ c√≥' : 'Ch∆∞a c√≥'">Ch∆∞a c√≥</div>
                                            <small class="text-muted">·∫¢nh hi·ªÉn th·ªã h·ªì s∆°</small>
                                        </div>
                                    </div>

                                    <!-- Ki·ªÉm tra ƒë·∫∑c tr∆∞ng AI -->
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-brain"
                                               th:classappend="${hasEmbedding} ? 'text-success' : 'text-muted'"></i>
                                        </div>
                                        <div class="detail-content">
                                            <div class="detail-label">ƒê·∫∑c tr∆∞ng AI</div>
                                            <div class="detail-status"
                                                 th:text="${hasEmbedding} ? 'ƒê√£ c√≥' : 'Ch∆∞a c√≥'">Ch∆∞a c√≥</div>
                                            <small class="text-muted">D·ªØ li·ªáu nh·∫≠n di·ªán</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Button -->
                                <div class="setup-action text-center">
                                    <div th:switch="${biometricStatus}">
                                        <div th:case="'completed'">
                                            <button class="btn btn-success btn-lg" disabled>
                                                <i class="fas fa-check me-2"></i>
                                                Sinh tr·∫Øc h·ªçc ƒë√£ ho√†n t·∫•t
                                            </button>
                                        </div>
                                        <div th:case="*">
                                            <a href="/student/profile" class="btn btn-primary btn-lg">
                                                <i class="fas fa-cog me-2"></i>
                                                Thi·∫øt l·∫≠p sinh tr·∫Øc h·ªçc
                                            </a>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="fas fa-book-open me-2"></i>
                                    M√¥n h·ªçc
                                </h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="stats-number h2" th:text="${totalSubjects ?: 0}">0</div>
                                <p class="text-muted">M√¥n ƒëang h·ªçc</p>
                                <a href="/student/lichhoc" class="btn btn-outline-primary">
                                    <i class="fas fa-calendar me-2"></i>Xem l·ªãch h·ªçc
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="card-title">
                                    <i class="fas fa-clipboard-check me-2"></i>
                                    ƒêi·ªÉm danh
                                </h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="stats-number h2" th:text="${attendanceStats?.present ?: 0}">0</div>
                                <p class="text-muted">L·∫ßn c√≥ m·∫∑t</p>
                                <!-- THAY ƒê·ªîI: Button m·ªü modal thay v√¨ link -->
                                <button class="btn btn-outline-primary" onclick="openAttendanceModal()" data-bs-toggle="modal" data-bs-target="#attendanceModal">
                                    <i class="fas fa-chart-line me-2"></i>Xem th·ªëng k√™
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="attendanceModal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="attendanceModalLabel">
                    <i class="fas fa-chart-bar me-2"></i>
                    Th·ªëng k√™ ƒêi·ªÉm danh
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <!-- T·ªïng quan -->
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <h4 class="mb-0" id="totalClasses">0</h4>
                                    <small>T·ªïng bu·ªïi h·ªçc</small>
                                </div>
                                <div class="col-md-3">
                                    <h4 class="mb-0 text-success" id="presentCount">0</h4>
                                    <small>C√≥ m·∫∑t</small>
                                </div>
                                <div class="col-md-3">
                                    <h4 class="mb-0 text-danger" id="absentCount">0</h4>
                                    <small>V·∫Øng m·∫∑t</small>
                                </div>
                                <div class="col-md-3">
                                    <h4 class="mb-0 text-primary" id="attendanceRate">0%</h4>
                                    <small>T·ª∑ l·ªá ƒëi h·ªçc</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Bi·ªÉu ƒë·ªì -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Bi·ªÉu ƒë·ªì ƒêi·ªÉm danh</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="attendanceChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Chi ti·∫øt theo m√¥n h·ªçc -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Chi ti·∫øt theo m√¥n h·ªçc</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <div id="subjectsList">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                                        </div>
                                        <p class="mt-2 text-muted">ƒêang t·∫£i th·ªëng k√™...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- B·∫£ng l·ªãch s·ª≠ chi ti·∫øt -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">L·ªãch s·ª≠ ƒêi·ªÉm danh g·∫ßn ƒë√¢y</h6>
                                <div class="filter-options">
                                    <select class="form-select form-select-sm" id="subjectFilter">
                                        <option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 300px;">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>M√¥n h·ªçc</th>
                                            <th>Ti·∫øt h·ªçc</th>
                                            <th>Tr·∫°ng th√°i</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                        </thead>
                                        <tbody id="attendanceHistory">
                                        <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="refreshAttendanceData()">
                    <i class="fas fa-sync-alt me-2"></i>L√†m m·ªõi
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS - T√°i s·ª≠ d·ª•ng sidebar.js hi·ªán c√≥ -->
<script th:src="@{/js/sidebar.js}"></script>

<script>
    // Update current date
    document.addEventListener('DOMContentLoaded', function() {
        const currentDateElement = document.getElementById('currentDate');
        if (currentDateElement) {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            currentDateElement.textContent = now.toLocaleDateString('vi-VN', options);
        }

        // Initialize sidebar - t∆∞∆°ng th√≠ch v·ªõi code hi·ªán t·∫°i
        if (typeof SidebarManager !== 'undefined') {
            new SidebarManager();
        }

        console.log('‚úÖ Student Dashboard loaded successfully');
        const attendanceModal = document.getElementById('attendanceModal');
        if (attendanceModal) {
            attendanceModal.addEventListener('hidden.bs.modal', function () {
                // Cleanup when modal is closed
                if (attendanceChart) {
                    attendanceChart.destroy();
                    attendanceChart = null;
                }
            });
        }
    });
    // Global variables
    let attendanceChart = null;
    let attendanceData = [];

    /**
     * M·ªü modal v√† load d·ªØ li·ªáu ƒëi·ªÉm danh
     */
    async function openAttendanceModal() {
        try {
            // Reset modal content
            resetModalContent();

            // Load attendance data
            await loadAttendanceStatistics();

            console.log('‚úÖ Attendance modal opened successfully');
        } catch (error) {
            console.error('‚ùå Error opening attendance modal:', error);
            showModalError('L·ªói khi t·∫£i d·ªØ li·ªáu ƒëi·ªÉm danh');
        }
    }

    /**
     * Reset n·ªôi dung modal
     */
    function resetModalContent() {
        // Reset summary stats
        document.getElementById('totalClasses').textContent = '0';
        document.getElementById('presentCount').textContent = '0';
        document.getElementById('absentCount').textContent = '0';
        document.getElementById('attendanceRate').textContent = '0%';

        // Reset subjects list
        document.getElementById('subjectsList').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
            <p class="mt-2 text-muted">ƒêang t·∫£i th·ªëng k√™...</p>
        </div>
    `;

        // Reset attendance history
        document.getElementById('attendanceHistory').innerHTML = '';

        // Destroy existing chart
        if (attendanceChart) {
            attendanceChart.destroy();
            attendanceChart = null;
        }
    }

    /**
     * Load d·ªØ li·ªáu th·ªëng k√™ ƒëi·ªÉm danh
     */
    async function loadAttendanceStatistics() {
        try {
            // Gi·∫£ s·ª≠ c√≥ API endpoint ƒë·ªÉ l·∫•y th·ªëng k√™ ƒëi·ªÉm danh c·ªßa sinh vi√™n
            const response = await fetch('/api/student/attendance-statistics');

            if (!response.ok) {
                throw new Error('Failed to load attendance statistics');
            }

            const data = await response.json();
            attendanceData = data;

            // Update summary statistics
            updateSummaryStats(data.summary);

            // Update subjects breakdown
            updateSubjectsList(data.bySubjects);

            // Create chart
            createAttendanceChart(data.chartData);

            // Load recent attendance history
            await loadAttendanceHistory();

            // Populate subject filter
            populateSubjectFilter(data.bySubjects);

        } catch (error) {
            console.error('Error loading attendance statistics:', error);
            showModalError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒëi·ªÉm danh');
        }
    }

    /**
     * C·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng quan
     */
    function updateSummaryStats(summary) {
        document.getElementById('totalClasses').textContent = summary.totalClasses || 0;
        document.getElementById('presentCount').textContent = summary.present || 0;
        document.getElementById('absentCount').textContent = summary.absent || 0;

        const rate = summary.totalClasses > 0 ?
            Math.round((summary.present / summary.totalClasses) * 100) : 0;
        document.getElementById('attendanceRate').textContent = rate + '%';
    }

    /**
     * C·∫≠p nh·∫≠t danh s√°ch m√¥n h·ªçc
     */
    function updateSubjectsList(subjects) {
        const container = document.getElementById('subjectsList');

        if (!subjects || subjects.length === 0) {
            container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-book-open fa-2x text-muted mb-2"></i>
                <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm danh</p>
            </div>
        `;
            return;
        }

        container.innerHTML = subjects.map(subject => {
            const rate = subject.totalClasses > 0 ?
                Math.round((subject.present / subject.totalClasses) * 100) : 0;

            const statusClass = rate >= 80 ? 'success' : rate >= 60 ? 'warning' : 'danger';

            return `
            <div class="subject-item border rounded p-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${subject.tenMh}</h6>
                        <small class="text-muted">${subject.maMh} - Nh√≥m ${subject.nhom}</small>
                    </div>
                    <span class="badge bg-${statusClass}">${rate}%</span>
                </div>
                <div class="mt-2">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">T·ªïng</small>
                            <div class="fw-bold">${subject.totalClasses}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-success">C√≥ m·∫∑t</small>
                            <div class="fw-bold text-success">${subject.present}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-danger">V·∫Øng</small>
                            <div class="fw-bold text-danger">${subject.absent}</div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar bg-${statusClass}" style="width: ${rate}%"></div>
                </div>
            </div>
        `;
        }).join('');
    }

    /**
     * T·∫°o bi·ªÉu ƒë·ªì ƒëi·ªÉm danh
     */
    function createAttendanceChart(chartData) {
        const ctx = document.getElementById('attendanceChart').getContext('2d');

        // Destroy existing chart
        if (attendanceChart) {
            attendanceChart.destroy();
        }

        attendanceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['C√≥ m·∫∑t', 'V·∫Øng m·∫∑t'],
                datasets: [{
                    data: [chartData.present || 0, chartData.absent || 0],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderColor: ['#ffffff', '#ffffff'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    /**
     * Load l·ªãch s·ª≠ ƒëi·ªÉm danh g·∫ßn ƒë√¢y
     */
    async function loadAttendanceHistory(subjectFilter = '') {
        try {
            let url = '/api/student/attendance-history?limit=50';
            if (subjectFilter) {
                url += `&subject=${encodeURIComponent(subjectFilter)}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load attendance history');

            const history = await response.json();

            const tbody = document.getElementById('attendanceHistory');

            if (!history || history.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                        <i class="fas fa-calendar-times fa-2x mb-2 d-block"></i>
                        Ch∆∞a c√≥ l·ªãch s·ª≠ ƒëi·ªÉm danh
                    </td>
                </tr>
            `;
                return;
            }

            tbody.innerHTML = history.map(record => {
                const statusClass = record.trangThai === 'C√≥ m·∫∑t' ? 'success' : 'danger';
                const statusIcon = record.trangThai === 'C√≥ m·∫∑t' ? 'check' : 'times';

                return `
                <tr>
                    <td>${formatDate(record.ngayHoc)}</td>
                    <td>
                        <div>${record.tenMh}</div>
                        <small class="text-muted">${record.maMh}</small>
                    </td>
                    <td>Ti·∫øt ${record.tietBatDau}-${record.tietBatDau + record.soTiet - 1}</td>
                    <td>
                        <span class="badge bg-${statusClass}">
                            <i class="fas fa-${statusIcon} me-1"></i>
                            ${record.trangThai}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted">${record.ghiChu || 'ƒêi·ªÉm danh t·ª± ƒë·ªông'}</small>
                    </td>
                </tr>
            `;
            }).join('');

        } catch (error) {
            console.error('Error loading attendance history:', error);
            document.getElementById('attendanceHistory').innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    L·ªói khi t·∫£i l·ªãch s·ª≠ ƒëi·ªÉm danh
                </td>
            </tr>
        `;
        }
    }

    /**
     * Populate subject filter dropdown
     */
    function populateSubjectFilter(subjects) {
        const select = document.getElementById('subjectFilter');

        // Clear existing options except first one
        select.innerHTML = '<option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>';

        if (subjects && subjects.length > 0) {
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.maMh;
                option.textContent = `${subject.tenMh} (${subject.maMh})`;
                select.appendChild(option);
            });
        }

        // Add event listener for filter change
        select.addEventListener('change', function() {
            loadAttendanceHistory(this.value);
        });
    }

    /**
     * Refresh attendance data
     */
    async function refreshAttendanceData() {
        await loadAttendanceStatistics();
        showToast('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu ƒëi·ªÉm danh', 'success');
    }

    /**
     * Show error in modal
     */
    function showModalError(message) {
        document.getElementById('subjectsList').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
            <p class="text-danger">${message}</p>
            <button class="btn btn-outline-primary btn-sm" onclick="loadAttendanceStatistics()">
                <i class="fas fa-sync-alt me-1"></i>Th·ª≠ l·∫°i
            </button>
        </div>
    `;
    }

    /**
     * Format date for display
     */
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    /**
     * Show toast notification
     */
    function showToast(message, type = 'info') {
        // Simple toast implementation - c√≥ th·ªÉ t√≠ch h·ª£p v·ªõi Bootstrap Toast
        const alertClass = type === 'success' ? 'alert-success' :
            type === 'error' ? 'alert-danger' : 'alert-info';

        const toast = document.createElement('div');
        toast.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    }
</script>

</body>
</html>