<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin c√° nh√¢n - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/student.css}" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007bff;
            --primary-light: #6c757d;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --white: #ffffff;
            --gray-50: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-500: #6c757d;
            --gray-700: #495057;
            --gray-900: #212529;
            --border-radius: 6px;
            --border-radius-lg: 12px;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Profile-specific styles */
        .profile-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .avatar-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .avatar-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid white;
            font-size: 3rem;
            color: white;
        }

        .upload-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .upload-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
        }

        /* Delete button for profile image */
        .profile-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .avatar-container:hover .profile-delete-btn {
            opacity: 1;
        }

        .profile-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Face images grid - Fixed slots */
        .face-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 3fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .face-image-slot {
            position: relative;
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--gray-50);
            overflow: hidden;
        }

        .face-image-slot:hover {
            border-color: var(--primary-color);
            background: rgba(0, 123, 255, 0.1);
        }

        .face-image-slot.has-image {
            border: 2px solid var(--success-color);
            padding: 0;
            cursor: default;
        }

        .face-image-slot.has-image:hover {
            border-color: var(--success-color);
            background: transparent;
        }

        .face-image-slot.uploading {
            border: 2px solid var(--warning-color);
            background: rgba(255, 193, 7, 0.1);
            cursor: wait;
        }

        .face-image-slot.loading {
            border: 2px solid var(--primary-color);
            background: rgba(0, 123, 255, 0.05);
        }

        .face-image-slot.error {
            border: 2px solid var(--danger-color);
            background: rgba(220, 53, 69, 0.05);
        }

        .face-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            opacity: 0;
        }

        .face-image.loaded {
            opacity: 1;
        }

        .face-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: var(--border-radius);
            z-index: 10;
        }

        .face-image-slot:hover .face-image-overlay {
            opacity: 1;
        }

        .face-image-overlay .delete-btn,
        .face-image-overlay .view-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 11;
            position: relative;
        }

        .face-image-overlay .delete-btn {
            color: var(--danger-color);
        }

        .face-image-overlay .view-btn {
            color: var(--primary-color);
        }

        .face-image-overlay .delete-btn:hover {
            background: var(--danger-color);
            color: white;
            transform: scale(1.1);
        }

        .face-image-overlay .view-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .upload-placeholder {
            text-align: center;
            color: var(--gray-500);
            padding: 1rem;
            pointer-events: none;
        }

        .slot-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .face-image-slot.has-image .slot-label {
            background: var(--success-color);
        }

        .face-image-slot.error .slot-label {
            background: var(--danger-color);
        }

        /* Image loading skeleton */
        .image-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.6;
        }

        .skeleton-text {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* Loading overlay for upload */
        .image-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: inherit;
            z-index: 30;
            backdrop-filter: blur(2px);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 8px;
        }

        .loading-progress {
            font-size: 0.8rem;
            color: #ffc107;
            font-weight: bold;
        }

        /* Biometric status */
        .biometric-status {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            text-align: center;
        }

        .biometric-status.status-empty {
            background-color: #fff3cd;
            border-left: 4px solid var(--warning-color);
            color: #856404;
        }

        .biometric-status.status-partial {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        .biometric-status.status-completed {
            background-color: #d4edda;
            border-left: 4px solid var(--success-color);
            color: #155724;
        }

        /* Info section */
        .info-section {
            padding: 2rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--gray-700);
        }

        .info-value {
            color: var(--gray-900);
        }

        /* Upload notification */
        .upload-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9998;
            min-width: 300px;
            display: none;
        }

        .upload-notification.show {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .avatar-container.uploading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            z-index: 20;
        }

        /* Change password modal styles */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: 12px 12px 0 0;
            border-bottom: none;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .input-group .btn-outline-secondary {
            border-color: #ced4da;
        }

        .input-group .btn-outline-secondary:hover {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }

        .progress-bar {
            transition: all 0.3s ease;
        }

        .password-weak {
            background-color: #dc3545 !important;
        }

        .password-medium {
            background-color: #ffc107 !important;
        }

        .password-strong {
            background-color: #28a745 !important;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
</head>

<body class="student-dashboard">
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">
                        <i class="fas fa-user-circle me-2"></i>
                        Th√¥ng tin c√° nh√¢n
                    </h1>
                </div>
                <div class="header-right">
                    <a href="/student/dashboard" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                    </a>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="container-fluid">
                <!-- Alert Messages -->
                <div id="alertContainer"></div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span th:text="${error}">L·ªói x·∫£y ra</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Profile Information Card -->
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="avatar-container">
                            <!-- Profile Image -->
                            <img th:if="${student?.hinhAnh}"
                                 th:src="${student.hinhAnh}"
                                 alt="Avatar"
                                 class="avatar-image"
                                 id="profileImage">

                            <!-- Placeholder if no image -->
                            <div th:unless="${student?.hinhAnh}"
                                 class="avatar-placeholder"
                                 id="profilePlaceholder">
                                <i class="fas fa-user"></i>
                            </div>

                            <!-- Upload/Change Button -->
                            <button class="upload-btn" onclick="document.getElementById('profileUpload').click()">
                                <i class="fas fa-camera"></i>
                            </button>

                            <!-- Hidden File Input -->
                            <input type="file"
                                   id="profileUpload"
                                   accept="image/*"
                                   style="display: none;"
                                   onchange="uploadProfileImage(this)">
                        </div>

                        <h3 th:text="${student?.hoTen ?: 'T√™n sinh vi√™n'}">T√™n sinh vi√™n</h3>
                        <p style="color: white" class="mb-0" th:text="'M√£ SV: ' + ${student?.maSv ?: 'N/A'}">M√£ SV: N/A</p>
                    </div>

                    <!-- Student Information -->
                    <div class="info-section">
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Th√¥ng tin c√° nh√¢n
                        </h5>

                        <div class="info-item">
                            <span class="info-label">M√£ sinh vi√™n:</span>
                            <span class="info-value" th:text="${student?.maSv ?: 'N/A'}">N/A</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">H·ªç v√† t√™n:</span>
                            <span class="info-value" th:text="${student?.hoTen ?: 'N/A'}">N/A</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">Ng√†y sinh:</span>
                            <span class="info-value" th:text="${student?.ngaySinh ?: 'N/A'}">N/A</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">Gi·ªõi t√≠nh:</span>
                            <span class="info-value" th:text="${student?.gioiTinh ?: 'N/A'}">N/A</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value" th:text="${student?.email ?: 'N/A'}">N/A</span>
                        </div>

                        <div class="info-item">
                            <span class="info-label">L·ªõp:</span>
                            <span class="info-value" th:text="${student?.getLop().tenLop ?: 'Ch∆∞a ph√¢n l·ªõp'}">Ch∆∞a ph√¢n l·ªõp</span>
                        </div>
                    </div>
                </div>

                <!-- Face Images Card -->
                <div class="profile-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-images me-2"></i>
                            ·∫¢nh khu√¥n m·∫∑t cho sinh tr·∫Øc h·ªçc
                        </h5>
                    </div>

                    <div class="info-section">
                        <!-- Biometric Status -->
                        <div id="biometricStatus" class="biometric-status">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="statusText">ƒêang t·∫£i th√¥ng tin...</span>
                        </div>

                        <!-- Th√™m v√†o cu·ªëi ph·∫ßn info-section trong profile card -->
                        <div class="info-item">
                            <span class="info-label">B·∫£o m·∫≠t:</span>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="openChangePasswordModal()">
                                <i class="fas fa-key me-2"></i>ƒê·ªïi m·∫≠t kh·∫©u
                            </button>
                        </div>

                        <p class="text-muted">
                            <i class="fas fa-lightbulb me-2"></i>
                            C·∫ßn t·ªëi thi·ªÉu 3 ·∫£nh khu√¥n m·∫∑t r√µ n√©t ƒë·ªÉ h·ªá th·ªëng c√≥ th·ªÉ nh·∫≠n di·ªán b·∫°n. T·ªëi ƒëa 5 ·∫£nh.
                        </p>

                        <!-- Face Images Grid with Fixed Slots -->
                        <div class="face-images-grid" id="faceImagesGrid">
                            <!-- Face image slots will be generated here -->
                        </div>

                        <!-- Hidden File Input for Face Images -->
                        <input type="file"
                               id="faceUpload"
                               accept="image/*"
                               style="display: none;"
                               onchange="uploadFaceImage(this)">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Notification -->
<div class="upload-notification" id="uploadNotification">
    <div class="notification-header">
        <div class="notification-title">
            <i class="fas fa-cloud-upload-alt me-2"></i>
            <span id="notificationTitle">ƒêang t·∫£i l√™n...</span>
        </div>
        <button class="notification-close" onclick="hideUploadNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="notification-progress">
        <div class="notification-progress-bar" id="notificationProgressBar"></div>
    </div>
    <div class="notification-text" id="notificationText">ƒêang chu·∫©n b·ªã...</div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="fas fa-key me-2"></i>Thay ƒë·ªïi m·∫≠t kh·∫©u
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">
                            <i class="fas fa-lock me-1"></i>M·∫≠t kh·∫©u hi·ªán t·∫°i
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="currentPassword" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newPassword" class="form-label">
                            <i class="fas fa-key me-1"></i>M·∫≠t kh·∫©u m·ªõi
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±</div>
                    </div>

                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">
                            <i class="fas fa-check me-1"></i>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmPassword" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Password strength indicator -->
                    <div class="mb-3">
                        <label class="form-label">ƒê·ªô m·∫°nh m·∫≠t kh·∫©u:</label>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="passwordStrengthText" class="text-muted">Nh·∫≠p m·∫≠t kh·∫©u m·ªõi</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary" onclick="changePassword()" id="changePasswordBtn">
                    <i class="fas fa-save me-2"></i>Thay ƒë·ªïi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script th:src="@{/js/sidebar.js}"></script>

<script>
    // ===== GLOBAL VARIABLES =====
    let faceImagesData = {}; // Object to store face images by index: {0: {id, filename, url}, 1: {...}}
    let currentUploadSlot = null;
    let uploadStartTime = null;
    const maxFaceImages = 5;

    // ===== INITIALIZE =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing Student Profile page...');

        // Initialize sidebar
        if (typeof SidebarManager !== 'undefined') {
            new SidebarManager();
        }

        // Initialize face image slots
        initializeFaceImageSlots();

        // Load face images
        loadFaceImages();

        // Add profile image delete button if image exists
        addProfileImageDeleteButton();

        console.log('‚úÖ Student Profile page loaded successfully');
    });

    // ===== SLOT MANAGEMENT =====
    function initializeFaceImageSlots() {
        console.log('üèóÔ∏è Initializing face image slots...');
        const grid = document.getElementById('faceImagesGrid');
        grid.innerHTML = '';

        // Initialize data object
        faceImagesData = {};

        // Create 5 fixed slots
        for (let i = 0; i < maxFaceImages; i++) {
            const slot = createFaceImageSlot(i);
            grid.appendChild(slot);
        }

        console.log('‚úÖ Face image slots initialized');
    }

    function createFaceImageSlot(slotIndex) {
        const slot = document.createElement('div');
        slot.className = 'face-image-slot';
        slot.setAttribute('data-slot-index', slotIndex);
        slot.innerHTML = `
            <div class="slot-label">·∫¢nh ${slotIndex + 1}</div>
            <div class="upload-placeholder">
                <i class="fas fa-plus fa-2x mb-2"></i>
                <div>Th√™m ·∫£nh ${slotIndex + 1}</div>
            </div>
        `;

        // Add click handler for empty slots
        slot.onclick = () => {
            if (!faceImagesData[slotIndex]) {
                currentUploadSlot = slotIndex;
                document.getElementById('faceUpload').click();
            }
        };

        return slot;
    }

    function updateSlotContent(slotIndex, imageData = null) {
        const slot = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        if (!slot) return;

        if (imageData) {
            // Update slot with image
            faceImagesData[slotIndex] = imageData;

            slot.className = 'face-image-slot has-image';
            slot.onclick = null; // Remove click handler

            // Add image with loading
            loadImageIntoSlot(slot, imageData.url, imageData.filename);

        } else {
            // Clear slot
            delete faceImagesData[slotIndex];

            slot.className = 'face-image-slot';
            slot.innerHTML = `
                <div class="slot-label">·∫¢nh ${slotIndex + 1}</div>
                <div class="upload-placeholder">
                    <i class="fas fa-plus fa-2x mb-2"></i>
                    <div>Th√™m ·∫£nh ${slotIndex + 1}</div>
                </div>
            `;

            // Re-add click handler
            slot.onclick = () => {
                currentUploadSlot = slotIndex;
                document.getElementById('faceUpload').click();
            };
        }
    }

    function loadImageIntoSlot(slot, imageUrl, filename) {
        console.log('üñºÔ∏è Loading image into slot:', imageUrl, 'filename:', filename);

        // Add skeleton loading
        addImageSkeleton(slot);

        // Create image element
        const img = document.createElement('img');
        img.className = 'face-image';
        img.alt = 'Face image';

        // Create overlay with proper event binding
        const overlay = document.createElement('div');
        overlay.className = 'face-image-overlay';

        // Create delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'X√≥a ·∫£nh';
        deleteBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const slotIndex = parseInt(slot.getAttribute('data-slot-index'));
            deleteFaceImageFromSlot(slotIndex);
        };

        // Create view button
        const viewBtn = document.createElement('button');
        viewBtn.className = 'view-btn';
        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
        viewBtn.title = 'Xem ·∫£nh';
        viewBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            viewFaceImage(imageUrl, filename);
        };

        overlay.appendChild(deleteBtn);
        overlay.appendChild(viewBtn);

        // Handle successful load
        img.onload = function() {
            console.log('‚úÖ Image loaded successfully in slot');
            removeImageSkeleton(slot);

            // Clear slot content and add image + overlay
            slot.innerHTML = `<div class="slot-label">·∫¢nh ${parseInt(slot.getAttribute('data-slot-index')) + 1}</div>`;
            img.classList.add('loaded');
            slot.appendChild(img);
            slot.appendChild(overlay);

            // Add debug event listeners
            slot.addEventListener('mouseenter', function() {
                console.log('üñ±Ô∏è Mouse enter slot:', slot.getAttribute('data-slot-index'));
            });

            overlay.addEventListener('mouseenter', function() {
                console.log('üëÅÔ∏è Mouse enter overlay:', slot.getAttribute('data-slot-index'));
            });

            deleteBtn.addEventListener('click', function(e) {
                console.log('üóëÔ∏è Delete button clicked for slot:', slot.getAttribute('data-slot-index'));
            });

            // Add double-click fallback for delete
            img.addEventListener('dblclick', function(e) {
                console.log('üëÜ Double-click detected on image in slot:', slot.getAttribute('data-slot-index'));
                const slotIndex = parseInt(slot.getAttribute('data-slot-index'));
                if (confirm('Double-click detected. B·∫°n c√≥ mu·ªën x√≥a ·∫£nh n√†y kh√¥ng?')) {
                    deleteFaceImageFromSlot(slotIndex);
                }
            });

            // Add context menu for alternative delete method
            img.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                console.log('üñ±Ô∏è Right-click detected on image in slot:', slot.getAttribute('data-slot-index'));
                const slotIndex = parseInt(slot.getAttribute('data-slot-index'));
                if (confirm('Right-click detected. B·∫°n c√≥ mu·ªën x√≥a ·∫£nh n√†y kh√¥ng?')) {
                    deleteFaceImageFromSlot(slotIndex);
                }
            });
        };

        // Handle load error
        img.onerror = function() {
            console.error('‚ùå Failed to load image in slot:', imageUrl);
            removeImageSkeleton(slot);
            // Show error state
            slot.classList.add('error');
        };

        // Start loading
        img.src = imageUrl;
    }

    // ===== UTILITY FUNCTIONS =====
    function validateImageFile(file) {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showAlert('danger', 'Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh JPG, PNG, WEBP');
            return false;
        }

        if (file.size > 5 * 1024 * 1024) {
            showAlert('danger', 'K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
            return false;
        }

        return true;
    }

    function showAlert(type, message, autoHide = true) {
        const alertContainer = document.getElementById('alertContainer');
        const alertId = 'alert_' + Date.now();

        const alert = document.createElement('div');
        alert.id = alertId;
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        alertContainer.appendChild(alert);

        if (autoHide) {
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
    }

    function findEmptySlot() {
        for (let i = 0; i < maxFaceImages; i++) {
            if (!faceImagesData[i]) {
                return i;
            }
        }
        return -1; // No empty slot found
    }

    function getImageCount() {
        return Object.keys(faceImagesData).length;
    }

    // ===== IMAGE LOADING FUNCTIONS =====
    function addImageSkeleton(element) {
        console.log('üíÄ Adding skeleton to slot');
        removeImageSkeleton(element);

        // Keep slot label
        const slotLabel = element.querySelector('.slot-label');

        const skeleton = document.createElement('div');
        skeleton.className = 'image-skeleton';
        skeleton.innerHTML = `
            <i class="fas fa-image skeleton-icon"></i>
            <div class="skeleton-text">ƒêang t·∫£i...</div>
        `;

        element.appendChild(skeleton);
        element.classList.add('loading');

        return skeleton;
    }

    function removeImageSkeleton(element) {
        const skeleton = element.querySelector('.image-skeleton');
        if (skeleton) {
            skeleton.remove();
        }
        element.classList.remove('loading');
    }

    // ===== UPLOAD LOADING FUNCTIONS =====
    function addImageLoadingOverlay(element, fileName) {
        console.log('üîÑ Adding upload loading overlay');
        removeImageLoadingOverlay(element);

        // Special handling for avatar container
        if (element.classList.contains('avatar-container')) {
            element.classList.add('uploading');
            return null;
        }

        const overlay = document.createElement('div');
        overlay.className = 'image-loading-overlay';
        overlay.innerHTML = `
            <div class="loading-spinner"></div>
            <div class="loading-text">ƒêang t·∫£i l√™n...</div>
            <div class="loading-progress" id="imageProgress_${Date.now()}">0%</div>
        `;

        element.appendChild(overlay);
        element.classList.add('uploading');

        return overlay;
    }

    function updateImageLoadingProgress(element, percent) {
        const overlay = element.querySelector('.image-loading-overlay');
        if (overlay) {
            const progressElement = overlay.querySelector('.loading-progress');
            if (progressElement) {
                progressElement.textContent = `${percent}%`;
            }
        }
    }

    function removeImageLoadingOverlay(element) {
        if (element.classList.contains('avatar-container')) {
            element.classList.remove('uploading');
            return;
        }

        const overlay = element.querySelector('.image-loading-overlay');
        if (overlay) {
            overlay.remove();
        }
        element.classList.remove('uploading');
    }

    // ===== NOTIFICATION FUNCTIONS =====
    function showUploadNotification(fileName, percent = 0) {
        const notification = document.getElementById('uploadNotification');
        const title = document.getElementById('notificationTitle');
        const progressBar = document.getElementById('notificationProgressBar');
        const text = document.getElementById('notificationText');

        if (title) title.textContent = `T·∫£i l√™n: ${fileName}`;
        if (progressBar) progressBar.style.width = `${percent}%`;
        if (text) text.textContent = `${percent}% ho√†n th√†nh`;

        notification.classList.add('show');
    }

    function updateUploadNotification(percent, status = 'ƒêang t·∫£i l√™n...') {
        const progressBar = document.getElementById('notificationProgressBar');
        const text = document.getElementById('notificationText');

        if (progressBar) progressBar.style.width = `${percent}%`;
        if (text) text.textContent = `${status} - ${percent}%`;
    }

    function hideUploadNotification() {
        const notification = document.getElementById('uploadNotification');
        notification.classList.remove('show');
    }

    // ===== MAIN UPLOAD FUNCTION =====
    function uploadImageWithProgress(file, uploadUrl, targetElement, successCallback) {
        if (!file || !validateImageFile(file)) {
            console.error('‚ùå Invalid file');
            return;
        }

        console.log('üöÄ Starting upload:', file.name);

        // Add loading overlay to target element
        const loadingOverlay = addImageLoadingOverlay(targetElement, file.name);

        // Show notification
        showUploadNotification(file.name, 0);

        // Prepare upload
        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        uploadStartTime = Date.now();

        // Progress tracking
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                console.log(`üìä Upload progress: ${percent}%`);

                updateImageLoadingProgress(targetElement, percent);
                updateUploadNotification(percent, 'ƒêang t·∫£i l√™n...');
            }
        };

        // Upload completion
        xhr.onload = () => {
            console.log('‚úÖ Upload completed, status:', xhr.status);
            removeImageLoadingOverlay(targetElement);

            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    console.log('üì¶ Server response:', response);

                    if (response.error) {
                        updateUploadNotification(100, 'L·ªói: ' + response.error);
                        showAlert('danger', response.error);
                        setTimeout(hideUploadNotification, 3000);
                    } else {
                        updateUploadNotification(100, 'T·∫£i l√™n th√†nh c√¥ng!');
                        showAlert('success', 'T·∫£i l√™n th√†nh c√¥ng!');
                        setTimeout(hideUploadNotification, 2000);

                        if (successCallback) {
                            successCallback(response);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå JSON parse error:', error);
                    updateUploadNotification(100, 'L·ªói ph·∫£n h·ªìi server');
                    showAlert('danger', 'L·ªói x·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ server');
                    setTimeout(hideUploadNotification, 3000);
                }
            } else {
                console.error('‚ùå HTTP error:', xhr.status);
                updateUploadNotification(100, `L·ªói HTTP ${xhr.status}`);
                showAlert('danger', `L·ªói khi t·∫£i l√™n (HTTP ${xhr.status})`);
                setTimeout(hideUploadNotification, 3000);
            }
        };

        // Error handling
        xhr.onerror = () => {
            console.error('‚ùå Network error');
            removeImageLoadingOverlay(targetElement);
            updateUploadNotification(100, 'L·ªói m·∫°ng');
            showAlert('danger', 'L·ªói m·∫°ng');
            setTimeout(hideUploadNotification, 3000);
        };

        xhr.ontimeout = () => {
            console.error('‚è∞ Timeout error');
            removeImageLoadingOverlay(targetElement);
            updateUploadNotification(100, 'Timeout');
            showAlert('danger', 'Timeout - Vui l√≤ng th·ª≠ l·∫°i');
            setTimeout(hideUploadNotification, 3000);
        };

        // Start upload
        showAlert('info', `B·∫Øt ƒë·∫ßu t·∫£i l√™n ${file.name}...`, true);
        xhr.timeout = 30000;
        xhr.open('POST', uploadUrl);
        xhr.send(formData);
    }

    // ===== UPLOAD HANDLERS =====
    function uploadProfileImage(input) {
        console.log('üì∏ Profile image upload triggered');

        if (!input.files || !input.files[0]) {
            console.log('‚ùå No file selected');
            return;
        }

        const file = input.files[0];
        console.log('üìÅ Selected file:', file.name, file.size, file.type);

        const avatarContainer = document.querySelector('.avatar-container');

        uploadImageWithProgress(
            file,
            '/student/api/upload-profile-image',
            avatarContainer,
            function(response) {
                console.log('‚úÖ Profile upload success:', response);

                const profileImage = document.getElementById('profileImage');
                const profilePlaceholder = document.getElementById('profilePlaceholder');

                if (profilePlaceholder && avatarContainer) {
                    const newImg = document.createElement('img');
                    newImg.id = 'profileImage';
                    newImg.className = 'avatar-image';
                    newImg.alt = 'Avatar';

                    newImg.onload = function() {
                        this.style.opacity = '1';
                        addProfileImageDeleteButton();
                    };

                    newImg.onerror = function() {
                        console.error('‚ùå Failed to load new profile image');
                        showAlert('danger', 'Kh√¥ng th·ªÉ hi·ªÉn th·ªã ·∫£nh ƒë√£ t·∫£i l√™n');
                    };

                    newImg.style.opacity = '0.7';
                    newImg.src = response.url || response.imageUrl;
                    avatarContainer.replaceChild(newImg, profilePlaceholder);

                } else if (profileImage) {
                    profileImage.style.opacity = '0.7';
                    profileImage.onload = function() {
                        this.style.opacity = '1';
                    };
                    profileImage.src = response.url || response.imageUrl;
                    addProfileImageDeleteButton();
                }
            }
        );
    }

    function uploadFaceImage(input) {
        console.log('üë§ Face image upload triggered');

        if (!input.files || !input.files[0]) {
            console.log('‚ùå No file selected');
            return;
        }

        const file = input.files[0];
        console.log('üìÅ Selected file:', file.name, file.size, file.type);

        // Check if we have reached the limit
        if (getImageCount() >= maxFaceImages) {
            showAlert('warning', 'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n t·ªëi ƒëa 5 ·∫£nh khu√¥n m·∫∑t');
            return;
        }

        // Use the selected slot or find an empty one
        let targetSlot = currentUploadSlot;
        if (targetSlot === null || faceImagesData[targetSlot]) {
            targetSlot = findEmptySlot();
        }

        if (targetSlot === -1) {
            showAlert('warning', 'Kh√¥ng t√¨m th·∫•y slot tr·ªëng ƒë·ªÉ upload');
            return;
        }

        console.log('üéØ Uploading to slot:', targetSlot);

        const slotElement = document.querySelector(`[data-slot-index="${targetSlot}"]`);

        uploadImageWithProgress(
            file,
            '/student/api/upload-face-image',
            slotElement,
            function(response) {
                console.log('‚úÖ Face upload success:', response);

                // Update the specific slot with the new image
                updateSlotContent(targetSlot, {
                    id: response.id || Date.now(),
                    filename: response.filename || file.name,
                    url: response.url || response.imageUrl
                });

                // Update biometric status
                updateBiometricStatus();

                // Reset current upload slot
                currentUploadSlot = null;
            }
        );

        // Reset input
        input.value = '';
    }

    // ===== DELETE FUNCTIONS =====
    function deleteProfileImage() {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh ƒë·∫°i di·ªán?')) return;

        console.log('üóëÔ∏è Deleting profile image...');
        showAlert('info', 'ƒêang x√≥a ·∫£nh ƒë·∫°i di·ªán...', false);

        fetch('/student/api/delete-profile-image', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('danger', data.error);
                } else {
                    const profileImage = document.getElementById('profileImage');
                    const avatarContainer = document.querySelector('.avatar-container');

                    if (profileImage && avatarContainer) {
                        const newPlaceholder = document.createElement('div');
                        newPlaceholder.id = 'profilePlaceholder';
                        newPlaceholder.className = 'avatar-placeholder';
                        newPlaceholder.innerHTML = '<i class="fas fa-user"></i>';

                        avatarContainer.replaceChild(newPlaceholder, profileImage);

                        const deleteBtn = document.querySelector('.profile-delete-btn');
                        if (deleteBtn) deleteBtn.remove();
                    }

                    showAlert('success', 'X√≥a ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!');
                }
            })
            .catch(error => {
                console.error('‚ùå Delete error:', error);
                showAlert('danger', 'C√≥ l·ªói x·∫£y ra khi x√≥a ·∫£nh');
            });
    }

    function deleteFaceImageFromSlot(slotIndex) {
        console.log('üóëÔ∏è Delete triggered for slot:', slotIndex);

        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ·∫£nh n√†y?')) return;

        const imageData = faceImagesData[slotIndex];
        if (!imageData) {
            console.error('‚ùå No image data found for slot:', slotIndex);
            showAlert('danger', 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ·∫£nh ƒë·ªÉ x√≥a');
            return;
        }

        console.log('üóëÔ∏è Deleting face image from slot:', slotIndex, 'filename:', imageData.filename);

        const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        addImageLoadingOverlay(slotElement, 'ƒêang x√≥a...');

        // Use the correct API endpoint format
        fetch(`/student/api/face-image/${encodeURIComponent(imageData.filename)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                console.log('üîÑ Delete response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üì¶ Delete response data:', data);
                removeImageLoadingOverlay(slotElement);

                if (data.error) {
                    console.error('‚ùå Delete error from server:', data.error);
                    showAlert('danger', data.error);
                } else {
                    // Clear the specific slot
                    updateSlotContent(slotIndex, null);

                    showAlert('success', 'X√≥a ·∫£nh th√†nh c√¥ng!');
                    updateBiometricStatus();

                    console.log('‚úÖ Image deleted successfully from slot:', slotIndex);
                }
            })
            .catch(error => {
                removeImageLoadingOverlay(slotElement);
                console.error('‚ùå Delete network error:', error);
                showAlert('danger', 'C√≥ l·ªói m·∫°ng khi x√≥a ·∫£nh: ' + error.message);
            });
    }

    function addProfileImageDeleteButton() {
        const avatarContainer = document.querySelector('.avatar-container');
        const profileImage = document.getElementById('profileImage');

        if (profileImage && !document.querySelector('.profile-delete-btn')) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'profile-delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = deleteProfileImage;
            deleteBtn.title = 'X√≥a ·∫£nh ƒë·∫°i di·ªán';

            avatarContainer.appendChild(deleteBtn);
        }
    }

    // Add this function to force show overlay and enable clicks
    function forceShowOverlay(slotIndex) {
        const slot = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        if (slot) {
            const overlay = slot.querySelector('.face-image-overlay');
            if (overlay) {
                overlay.style.opacity = '1';
                overlay.style.pointerEvents = 'auto';
                console.log('üëÅÔ∏è Forced overlay to show for slot:', slotIndex);

                // Hide after 3 seconds
                setTimeout(() => {
                    overlay.style.opacity = '';
                    overlay.style.pointerEvents = '';
                }, 3000);
            }
        }
    }

    // Add this function to manually trigger delete for any slot
    function manualDeleteSlot(slotIndex) {
        console.log('üîß Manual delete triggered for slot:', slotIndex);
        if (faceImagesData[slotIndex]) {
            deleteFaceImageFromSlot(slotIndex);
        } else {
            console.log('‚ùå No image data found for slot:', slotIndex);
            showAlert('warning', 'Slot ' + (slotIndex + 1) + ' kh√¥ng c√≥ ·∫£nh ƒë·ªÉ x√≥a');
        }
    }

    /*
     * ===== DEBUGGING INSTRUCTIONS =====
     * N·∫øu kh√¥ng x√≥a ƒë∆∞·ª£c ·∫£nh, m·ªü Console (F12) v√† th·ª≠ c√°c l·ªánh sau:
     *
     * 1. Ki·ªÉm tra d·ªØ li·ªáu slot: debugSlotData(0)  // thay 0 b·∫±ng s·ªë slot
     * 2. Test x√≥a slot: testDeleteSlot(0)         // thay 0 b·∫±ng s·ªë slot
     * 3. X√≥a tr·ª±c ti·∫øp: manualDeleteSlot(0)       // thay 0 b·∫±ng s·ªë slot
     * 4. Hi·ªán overlay: forceShowOverlay(0)        // thay 0 b·∫±ng s·ªë slot
     * 5. Xem t·∫•t c·∫£ d·ªØ li·ªáu: console.log(window.faceImagesData)
     *
     * Alternative methods:
     * - Double-click v√†o ·∫£nh ƒë·ªÉ x√≥a
     * - Right-click v√†o ·∫£nh ƒë·ªÉ x√≥a
     */

    // Expose these functions to window for console debugging
    window.forceShowOverlay = forceShowOverlay;
    window.manualDeleteSlot = manualDeleteSlot;
    function debugSlotData(slotIndex) {
        console.log('üîç Debug slot data for slot:', slotIndex);
        console.log('üìä All faceImagesData:', faceImagesData);
        console.log('üìã Slot', slotIndex, 'data:', faceImagesData[slotIndex]);

        const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        console.log('üéØ Slot element:', slotElement);

        if (slotElement) {
            const overlay = slotElement.querySelector('.face-image-overlay');
            console.log('üëÅÔ∏è Overlay element:', overlay);

            if (overlay) {
                const deleteBtn = overlay.querySelector('.delete-btn');
                const viewBtn = overlay.querySelector('.view-btn');
                console.log('üóëÔ∏è Delete button:', deleteBtn);
                console.log('üëÄ View button:', viewBtn);
            }
        }
    }

    // Add this to test delete functionality
    function testDeleteSlot(slotIndex) {
        console.log('üß™ Testing delete for slot:', slotIndex);
        debugSlotData(slotIndex);
        deleteFaceImageFromSlot(slotIndex);
    }

    // Expose debugging functions to window for console access
    window.debugSlotData = debugSlotData;
    window.testDeleteSlot = testDeleteSlot;
    window.faceImagesData = faceImagesData;
    function loadFaceImages() {
        console.log('üìã Loading face images...');

        fetch('/student/api/get-face-images')
            .then(response => {
                console.log('üîÑ Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üì¶ Face images data:', data);

                // Clear all slots first
                initializeFaceImageSlots();

                // Load images based on current API response format
                if (data.images && data.images.length > 0) {
                    console.log('üì∏ Loading', data.images.length, 'face images');

                    // Current API returns array of images, load them sequentially
                    data.images.forEach((image, index) => {
                        console.log(`üì∑ Loading image ${index}:`, image);

                        if (index < maxFaceImages && image.filename && image.url) {
                            updateSlotContent(index, {
                                id: image.id,
                                filename: image.filename,
                                url: image.url
                            });
                        } else {
                            console.warn('‚ö†Ô∏è Skipping invalid image data:', image);
                        }
                    });
                } else {
                    console.log('üì∑ No face images found');
                }

                updateBiometricStatus();
                console.log('‚úÖ Face images loaded successfully');
                console.log('üîç Current face images data:', faceImagesData);
            })
            .catch(error => {
                console.error('‚ùå Error loading face images:', error);
                showAlert('danger', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ·∫£nh: ' + error.message);
                updateBiometricStatus();
            });
    }

    function updateBiometricStatus() {
        const statusDiv = document.getElementById('biometricStatus');
        const statusText = document.getElementById('statusText');
        const currentCount = getImageCount();

        statusDiv.className = 'biometric-status';

        if (currentCount >= 3) {
            statusDiv.classList.add('status-completed');
            statusText.innerHTML = '<i class="fas fa-check-circle me-2"></i>ƒê√£ c√≥ ƒë·ªß ·∫£nh ƒë·ªÉ nh·∫≠n di·ªán';
        } else if (currentCount > 0) {
            statusDiv.classList.add('status-partial');
            statusText.innerHTML = `<i class="fas fa-clock me-2"></i>C·∫ßn th√™m ${3 - currentCount} ·∫£nh n·ªØa`;
        } else {
            statusDiv.classList.add('status-empty');
            statusText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Ch∆∞a c√≥ ·∫£nh khu√¥n m·∫∑t n√†o';
        }
    }

    function viewFaceImage(imageUrl, filename) {
        let modal = document.getElementById('imageViewModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'imageViewModal';
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Xem ·∫£nh khu√¥n m·∫∑t</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img id="modalImage" src="" alt="Face image" class="img-fluid">
                            <p id="modalFilename" class="mt-2 text-muted"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" id="modalDeleteBtn">
                                <i class="fas fa-trash me-2"></i>X√≥a ·∫£nh
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('modalFilename').textContent = filename;

        const deleteBtn = document.getElementById('modalDeleteBtn');
        deleteBtn.onclick = () => {
            bootstrap.Modal.getInstance(modal).hide();
            setTimeout(() => {
                // Find which slot contains this filename
                for (let i = 0; i < maxFaceImages; i++) {
                    if (faceImagesData[i] && faceImagesData[i].filename === filename) {
                        deleteFaceImageFromSlot(i);
                        break;
                    }
                }
            }, 300);
        };

        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }

    // ===== CHANGE PASSWORD FUNCTIONS =====

    function openChangePasswordModal() {
        const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
        modal.show();

        // Reset form
        document.getElementById('changePasswordForm').reset();
        updatePasswordStrength('');
    }

    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;
        const icon = button.querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }

    function updatePasswordStrength(password) {
        const strengthBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('passwordStrengthText');

        let strength = 0;
        let text = '';
        let className = '';

        if (password.length === 0) {
            text = 'Nh·∫≠p m·∫≠t kh·∫©u m·ªõi';
        } else if (password.length < 6) {
            strength = 25;
            text = 'Qu√° ng·∫Øn';
            className = 'password-weak';
        } else {
            // Check password strength
            let score = 0;
            if (password.length >= 8) score += 25;
            if (/[a-z]/.test(password)) score += 25;
            if (/[A-Z]/.test(password)) score += 25;
            if (/[0-9]/.test(password)) score += 25;
            if (/[^a-zA-Z0-9]/.test(password)) score += 25;

            strength = Math.min(score, 100);

            if (strength < 50) {
                text = 'Y·∫øu';
                className = 'password-weak';
            } else if (strength < 75) {
                text = 'Trung b√¨nh';
                className = 'password-medium';
            } else {
                text = 'M·∫°nh';
                className = 'password-strong';
            }
        }

        strengthBar.style.width = strength + '%';
        strengthBar.className = 'progress-bar ' + className;
        strengthText.textContent = text;
        strengthText.className = 'form-text ' + className;
    }

    function validatePasswords() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showAlert('danger', 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
            return false;
        }

        if (newPassword.length < 6) {
            showAlert('danger', 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
            return false;
        }

        return true;
    }

    function changePassword() {
        console.log('üîê Change password triggered');

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validate inputs
        if (!currentPassword || !newPassword || !confirmPassword) {
            showAlert('danger', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
            return;
        }

        if (!validatePasswords()) {
            return;
        }

        // Disable button during request
        const changeBtn = document.getElementById('changePasswordBtn');
        const originalText = changeBtn.innerHTML;
        changeBtn.disabled = true;
        changeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';

        // Prepare request data
        const requestData = {
            currentPassword: currentPassword,
            newPassword: newPassword,
            confirmPassword: confirmPassword
        };

        console.log('üì§ Sending change password request');

        fetch('/student/api/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                console.log('üîÑ Change password response status:', response.status);
                return response.json().then(data => ({
                    status: response.status,
                    ok: response.ok,
                    data: data
                }));
            })
            .then(result => {
                console.log('üì¶ Change password response:', result);

                // Re-enable button
                changeBtn.disabled = false;
                changeBtn.innerHTML = originalText;

                if (result.ok && !result.data.error) {
                    showAlert('success', 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();

                    // Reset form
                    document.getElementById('changePasswordForm').reset();
                    updatePasswordStrength('');

                } else {
                    const errorMessage = result.data.error || result.data.message || 'Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u';
                    showAlert('danger', errorMessage);
                }
            })
            .catch(error => {
                console.error('‚ùå Change password error:', error);

                // Re-enable button
                changeBtn.disabled = false;
                changeBtn.innerHTML = originalText;

                showAlert('danger', 'C√≥ l·ªói m·∫°ng khi ƒë·ªïi m·∫≠t kh·∫©u: ' + error.message);
            });
    }

    // Add event listeners when document loads
    document.addEventListener('DOMContentLoaded', function() {
        // Password strength checker
        const newPasswordInput = document.getElementById('newPassword');
        if (newPasswordInput) {
            newPasswordInput.addEventListener('input', function() {
                updatePasswordStrength(this.value);
            });
        }

        // Enter key to submit
        const modal = document.getElementById('changePasswordModal');
        if (modal) {
            modal.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
                    e.preventDefault();
                    changePassword();
                }
            });
        }
    });

</script>

</body>
</html>